# 시스템 아키텍처 명세서

**작성일**: 2025-11-03
**버전**: 0.4.0
**프로젝트**: Octo Worker - LangGraph 멀티 에이전트 챗봇

---

## 목차

1. [시스템 개요](#시스템-개요)
2. [기술 스택](#기술-스택)
3. [시스템 아키텍처](#시스템-아키텍처)
4. [주요 컴포넌트](#주요-컴포넌트)
5. [데이터베이스 설계](#데이터베이스-설계)
6. [보안 및 인증](#보안-및-인증)
7. [확장성 및 성능](#확장성-및-성능)

---

## 시스템 개요

### 프로젝트 목적

Octo Worker는 LangGraph 1.0 기반의 멀티 에이전트 오케스트레이션 시스템입니다. Supervisor Pattern을 활용하여 여러 전문 에이전트를 조율하고, 사용자의 복잡한 요청을 효율적으로 처리합니다.

### 핵심 기능

- **멀티 에이전트 시스템**: Supervisor가 여러 전문 에이전트를 조율
- **Human-in-the-Loop (HITL)**: 중요한 단계에서 사람의 승인 요청
- **세션 관리**: PostgreSQL 기반 영구 상태 저장
- **실시간 스트리밍**: WebSocket을 통한 실시간 응답
- **REST API**: 세션 조회, 관리, 재개 기능

---

## 기술 스택

### Backend Framework

- **FastAPI** 0.104+
  - 고성능 비동기 웹 프레임워크
  - 자동 API 문서 생성 (OpenAPI/Swagger)
  - WebSocket 지원

### AI/ML Stack

- **LangGraph** 1.0
  - 상태 기반 에이전트 오케스트레이션
  - Checkpointing 지원
  - Human-in-the-Loop 패턴

- **LangChain** 0.3+
  - LLM 추상화 레이어
  - 메시지 타입 (HumanMessage, AIMessage 등)

- **OpenAI GPT-4**
  - 주요 언어 모델
  - 고성능 자연어 이해 및 생성

### Database

- **PostgreSQL** 13+
  - 세션 상태 영구 저장
  - AsyncPostgresSaver를 통한 체크포인트 저장

- **psycopg** 3.0+
  - 비동기 PostgreSQL 드라이버

### Development Tools

- **uv**: Python 패키지 관리
- **pytest**: 테스트 프레임워크
- **dotenv**: 환경 변수 관리

---

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        Client Layer                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  REST Client │  │   WebSocket  │  │  Web Browser │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
└─────────┼──────────────────┼──────────────────┼──────────────────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             │
┌─────────────────────────────┼────────────────────────────────────┐
│                     API Gateway (FastAPI)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  REST Router │  │   WebSocket  │  │    CORS      │          │
│  │  /api/*      │  │   /ws/*      │  │   Middleware │          │
│  └──────┬───────┘  └──────┬───────┘  └──────────────┘          │
└─────────┼──────────────────┼───────────────────────────────────┘
          │                  │
          └──────────────────┼──────────────────┐
                             │                  │
┌────────────────────────────┼──────────────────┼─────────────────┐
│               Application Layer (LangGraph)                       │
│                            │                  │                  │
│  ┌─────────────────────────┼──────────────────┼───────────────┐ │
│  │           Supervisor Graph (StateGraph)                     │ │
│  │                         │                  │                │ │
│  │  ┌──────────────────────▼──────────────────▼─────────────┐ │ │
│  │  │            Intent Understanding Node                   │ │ │
│  │  │  - 사용자 의도 분석                                      │ │ │
│  │  │  - 카테고리 분류                                         │ │ │
│  │  └───────────────────────┬────────────────────────────────┘ │ │
│  │                          │                                   │ │
│  │  ┌───────────────────────▼────────────────────────────────┐ │ │
│  │  │              Planning Node                              │ │ │
│  │  │  - 실행 계획 수립                                         │ │ │
│  │  │  - 에이전트 할당                                          │ │ │
│  │  └───────────────────────┬────────────────────────────────┘ │ │
│  │                          │                                   │ │
│  │  ┌───────────────────────▼────────────────────────────────┐ │ │
│  │  │              Router Node                                │ │ │
│  │  │  - 다음 에이전트 선택                                     │ │ │
│  │  │  - HITL 체크                                            │ │ │
│  │  └───────────┬─────────────┬───────────────┬──────────────┘ │ │
│  │              │             │               │                │ │
│  │  ┌───────────▼──┐  ┌──────▼─────┐  ┌─────▼──────────────┐ │ │
│  │  │ Search Agent │  │ Web Agent  │  │ Contract Agent ... │ │ │
│  │  └───────────┬──┘  └──────┬─────┘  └─────┬──────────────┘ │ │
│  │              │             │               │                │ │
│  │  ┌───────────▼─────────────▼───────────────▼──────────────┐ │ │
│  │  │              Aggregator Node                            │ │ │
│  │  │  - 결과 통합                                             │ │ │
│  │  │  - 최종 응답 생성                                         │ │ │
│  │  └──────────────────────────────────────────────────────┘ │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │           Session Management Layer                        │  │
│  │  - SessionManager: 세션 생성/조회/삭제                      │  │
│  │  - CheckpointerManager: 체크포인트 관리                     │  │
│  └──────────────────────────────────────────────────────────┘  │
└──────────────────────────────┬───────────────────────────────────┘
                               │
┌──────────────────────────────▼───────────────────────────────────┐
│                    Data Layer                                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              PostgreSQL Database                          │   │
│  │  ┌────────────────┐  ┌────────────────┐                 │   │
│  │  │  checkpoints   │  │  checkpoint_    │                 │   │
│  │  │  (상태 저장)    │  │  writes         │                 │   │
│  │  └────────────────┘  └────────────────┘                 │   │
│  └──────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────┘
                               │
┌──────────────────────────────▼───────────────────────────────────┐
│                    External Services                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  OpenAI API  │  │  Search APIs │  │   Web Scraper│          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└──────────────────────────────────────────────────────────────────┘
```

---

## 주요 컴포넌트

### 1. API Gateway (FastAPI)

**위치**: `backend/app/main.py`

**책임**:
- HTTP/WebSocket 요청 라우팅
- CORS 미들웨어 관리
- 전역 예외 처리
- API 문서 자동 생성

**주요 엔드포인트**:
- `GET /`: 헬스 체크
- `POST /chat`: 동기 채팅 API
- `GET /api/sessions`: 세션 목록 조회
- `WS /ws/{session_id}`: WebSocket 스트리밍

---

### 2. Supervisor Graph (LangGraph)

**위치**: `backend/app/octostrator/supervisor/graph.py`

**책임**:
- 에이전트 오케스트레이션
- 상태 관리 (StateGraph)
- 워크플로우 제어

**노드 구성**:
1. **intent_understanding**: 사용자 의도 파악
2. **planning**: 실행 계획 수립
3. **router**: 에이전트 라우팅 및 HITL 체크
4. **agents**: 각 전문 에이전트 (search, web, contract 등)
5. **aggregator**: 결과 통합 및 응답 생성

**상태 스키마**:
```python
class SupervisorState(TypedDict):
    messages: Annotated[list, add_messages]
    user_intent: Optional[dict]
    plan: Optional[dict]
    current_step: int
    is_planning: bool
    is_executing: bool
    aggregated_data: Optional[dict]
    output_format: str
    final_result: Optional[str]
    is_waiting_human: bool  # HITL 상태
```

---

### 3. Session Management

**위치**: `backend/app/octostrator/session/`

**컴포넌트**:

#### SessionManager
- 세션 생성, 조회, 삭제
- 메모리 기반 세션 메타데이터 관리
- thread_id 기반 세션 식별

#### CheckpointerManager
- PostgreSQL 체크포인터 싱글톤 관리
- 연결 풀 최적화
- 자동 테이블 생성

**주요 기능**:
```python
def get_session_config(thread_id: str) -> dict:
    """LangGraph Config 생성"""
    return {"configurable": {"thread_id": thread_id}}
```

---

### 4. Agents

**위치**: `backend/app/octostrator/agents/`

**에이전트 타입**:
1. **Search Agent**: 정보 검색
2. **Web Agent**: 웹 크롤링
3. **Contract Agent**: 계약서 작성
4. **Code Agent**: 코드 생성
5. **Data Agent**: 데이터 분석

**공통 인터페이스**:
```python
async def execute(state: dict) -> dict:
    """에이전트 실행 로직"""
    pass
```

---

### 5. HITL (Human-in-the-Loop)

**위치**: `backend/app/octostrator/supervisor/nodes/router.py`

**동작 방식**:
1. 중요 단계 탐지 (계약서 작성, 결제 등)
2. `interrupt()` 호출로 그래프 일시 중지
3. 사용자 승인 대기 (`is_waiting_human: True`)
4. REST API로 재개 (`POST /api/sessions/{thread_id}/resume`)

**재개 옵션**:
- `approve: true`: 자동 승인
- `response: "수정사항"`: 사용자 피드백 포함

---

### 6. Checkpointer (PostgreSQL)

**위치**: `backend/app/octostrator/checkpointer/postgres_checkpointer.py`

**기능**:
- 모든 그래프 상태를 PostgreSQL에 저장
- 세션 복원 및 타임 트래블
- 병렬 처리 지원 (async)

**테이블 구조**:
```sql
CREATE TABLE IF NOT EXISTS checkpoints (
    thread_id TEXT,
    checkpoint_id TEXT,
    checkpoint_ns TEXT,
    type TEXT,
    checkpoint BYTEA,
    metadata BYTEA,
    PRIMARY KEY (thread_id, checkpoint_ns, checkpoint_id)
);
```

---

## 데이터베이스 설계

### PostgreSQL Schema

#### checkpoints 테이블
| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| thread_id | TEXT | 세션 식별자 |
| checkpoint_id | TEXT | 체크포인트 고유 ID |
| checkpoint_ns | TEXT | 네임스페이스 |
| type | TEXT | 체크포인트 타입 |
| checkpoint | BYTEA | 상태 데이터 (직렬화) |
| metadata | BYTEA | 메타데이터 |

#### checkpoint_writes 테이블
| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| thread_id | TEXT | 세션 식별자 |
| checkpoint_ns | TEXT | 네임스페이스 |
| checkpoint_id | TEXT | 체크포인트 ID |
| task_id | TEXT | 태스크 ID |
| idx | INTEGER | 순서 |
| channel | TEXT | 채널명 |
| type | TEXT | 쓰기 타입 |
| value | BYTEA | 값 (직렬화) |

---

## 보안 및 인증

### 환경 변수 관리

**파일**: `.env`
```bash
# OpenAI API
OPENAI_API_KEY=sk-...

# PostgreSQL
POSTGRES_URL=postgresql://user:pass@host:port/db

# System
SYSTEM_DEBUG=False
SYSTEM_API_HOST=0.0.0.0
SYSTEM_API_PORT=8000

# CORS
SYSTEM_ALLOWED_ORIGINS=http://localhost:3000
```

### CORS 설정

**위치**: `backend/app/main.py`
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=config.system_allowed_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## 확장성 및 성능

### 비동기 처리

- FastAPI의 `async/await` 활용
- LangGraph의 `ainvoke()` 사용
- PostgreSQL 비동기 드라이버 (psycopg)

### 연결 풀링

- CheckpointerManager의 싱글톤 패턴
- PostgreSQL 연결 재사용

### 스트리밍

- WebSocket을 통한 실시간 응답
- `astream_events()` 활용한 이벤트 스트리밍

### 수평 확장 가능성

- 상태 저장을 PostgreSQL로 외부화
- 세션별 독립적인 처리
- 로드 밸런서 뒤 여러 인스턴스 배포 가능

---

## 버전 정보

- **Phase 4.1**: PostgreSQL Checkpointer
- **Phase 4.2**: HITL interrupt()
- **Phase 4.3**: WebSocket 실시간 스트리밍
- **Phase 4.4**: REST API 세션 관리

---

## 참조 문서

- [API 명세서](./API_명세서_251103.md)
- [시스템 플로우차트](./시스템_플로우차트_251103.md)
- [에이전트 플로우차트](./에이전트_플로우차트_251103.md)
- [사용자 메뉴얼](./사용자_메뉴얼_251103.md)
- [개발자 가이드](./개발자_가이드_251103.md)
