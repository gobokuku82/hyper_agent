# ì‚¬ìš©ì ë©”ë‰´ì–¼

**ì‘ì„±ì¼**: 2025-11-03
**ë²„ì „**: 0.4.0

---

## ëª©ì°¨

1. [ì‹œì‘í•˜ê¸°](#ì‹œì‘í•˜ê¸°)
2. [ê¸°ë³¸ ì‚¬ìš©ë²•](#ê¸°ë³¸-ì‚¬ìš©ë²•)
3. [REST API ì‚¬ìš©](#rest-api-ì‚¬ìš©)
4. [WebSocket ì‚¬ìš©](#websocket-ì‚¬ìš©)
5. [ì„¸ì…˜ ê´€ë¦¬](#ì„¸ì…˜-ê´€ë¦¬)
6. [HITL ì²˜ë¦¬](#hitl-ì²˜ë¦¬)
7. [ë¬¸ì œ í•´ê²°](#ë¬¸ì œ-í•´ê²°)

---

## ì‹œì‘í•˜ê¸°

### ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­

- **Python**: 3.11 ì´ìƒ
- **PostgreSQL**: 13 ì´ìƒ
- **OS**: Windows, macOS, Linux

### í™˜ê²½ ì„¤ì •

1. **.env íŒŒì¼ í™•ì¸**

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— `.env` íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ë‹¤ìŒ ë‚´ìš©ì´ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤:

```bash
# OpenAI API
OPENAI_API_KEY=sk-...

# PostgreSQL
POSTGRES_URL=postgresql://user:password@localhost:5432/octo_chatbot

# System
SYSTEM_DEBUG=False
SYSTEM_API_HOST=0.0.0.0
SYSTEM_API_PORT=8000

# CORS
SYSTEM_ALLOWED_ORIGINS=http://localhost:3000
```

2. **ì„œë²„ ì‹œì‘**

```bash
# uvë¥¼ ì‚¬ìš©í•œ ì„œë²„ ì‹¤í–‰
uv run python run_server.py
```

ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ë©´ ë‹¤ìŒ ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤:

```
INFO:     Started server process [PID]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

3. **ì„œë²„ í™•ì¸**

ë¸Œë¼ìš°ì €ì—ì„œ `http://localhost:8000`ì— ì ‘ì†í•˜ì—¬ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.

```json
{
  "message": "LangGraph Chatbot API",
  "version": "0.4.0",
  "status": "running"
}
```

---

## ê¸°ë³¸ ì‚¬ìš©ë²•

### API ë¬¸ì„œ í™•ì¸

FastAPIëŠ” ìë™ìœ¼ë¡œ API ë¬¸ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤:

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

ì—¬ê¸°ì„œ ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ì¶œë ¥ í˜•ì‹ ì„ íƒ

ì‹œìŠ¤í…œì€ ì„¸ ê°€ì§€ ì¶œë ¥ í˜•ì‹ì„ ì§€ì›í•©ë‹ˆë‹¤. ì‚¬ìš© ëª©ì ì— ë”°ë¼ ì ì ˆí•œ í˜•ì‹ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 1. `"chat"` - ëŒ€í™”í˜• í…ìŠ¤íŠ¸ (ê¸°ë³¸ê°’)

ì¼ë°˜ì ì¸ ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ì— ì í•©í•œ í˜•ì‹ì…ë‹ˆë‹¤.

**íŠ¹ì§•**:
- ì´ëª¨ì§€ í¬í•¨ ìš”ì•½
- ì‹¤í–‰ ë‹¨ê³„ ë° ì¸ì‚¬ì´íŠ¸ í¬í•¨
- ì½ê¸° ì‰¬ìš´ í…ìŠ¤íŠ¸ í˜•ì‹

**ì‚¬ìš© ì˜ˆì‹œ**:
- ì¼ë°˜ ì±„íŒ… ë´‡
- ê³ ê° ì§€ì› ì‹œìŠ¤í…œ
- FAQ ì‘ë‹µ

**ì‘ë‹µ ì˜ˆì‹œ**:
```
íŒŒì´ì¬ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì— ëŒ€í•´ ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤...

---

ğŸ“Š **ì‹¤í–‰ ìš”ì•½**
- ì´ 3ê°œ ë‹¨ê³„ ì‹¤í–‰
- ì™„ë£Œ: 3ê°œ
- ì‹¤íŒ¨: 0ê°œ

ğŸ’¡ **ì£¼ìš” ì¸ì‚¬ì´íŠ¸**
- async/await í‚¤ì›Œë“œ ì‚¬ìš©
- asyncio ë¼ì´ë¸ŒëŸ¬ë¦¬ í™œìš©
```

---

### 2. `"graph"` - ê·¸ë˜í”„ ì‹œê°í™”

ì‹¤í–‰ ê³¼ì •ì„ ì‹œê°ì ìœ¼ë¡œ í‘œí˜„í•˜ëŠ” ê·¸ë˜í”„ ë°ì´í„°ì…ë‹ˆë‹¤.

**íŠ¹ì§•**:
- nodes/edges êµ¬ì¡°ì˜ JSON
- D3.js, Cytoscape.js, React Flow ë“±ìœ¼ë¡œ ë Œë”ë§ ê°€ëŠ¥
- ì‹¤í–‰ í”Œë¡œìš°ë¥¼ ì‹œê°ì ìœ¼ë¡œ í‘œí˜„

**ì‚¬ìš© ì˜ˆì‹œ**:
- ì›Œí¬í”Œë¡œìš° ì‹œê°í™”
- í”„ë¡œì„¸ìŠ¤ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ
- ë³µì¡í•œ ì‘ì—…ì˜ ë‹¨ê³„ë³„ ì¶”ì 

**ì‘ë‹µ ì˜ˆì‹œ**:
```json
{
  "nodes": [
    {
      "id": "start",
      "label": "START",
      "type": "start",
      "color": "#4CAF50"
    },
    {
      "id": "step_1",
      "label": "ğŸ” search\në°ì´í„° ê²€ìƒ‰...",
      "type": "search",
      "status": "completed",
      "color": "#4CAF50"
    }
  ],
  "edges": [
    {
      "id": "edge_start_to_step_1",
      "source": "start",
      "target": "step_1"
    }
  ],
  "metadata": {
    "total_steps": 3,
    "completed": 3,
    "failed": 0
  }
}
```

---

### 3. `"report"` - ë§ˆí¬ë‹¤ìš´ ë³´ê³ ì„œ

êµ¬ì¡°í™”ëœ ë¬¸ì„œ í˜•ì‹ì˜ ë³´ê³ ì„œì…ë‹ˆë‹¤.

**íŠ¹ì§•**:
- ë§ˆí¬ë‹¤ìš´ í˜•ì‹
- PDF ë³€í™˜ ê°€ëŠ¥
- ìƒì„¸í•œ ì‹¤í–‰ ë‚´ì—­ í¬í•¨

**ì‚¬ìš© ì˜ˆì‹œ**:
- ì—…ë¬´ ë³´ê³ ì„œ
- ë¶„ì„ ë¦¬í¬íŠ¸
- ë¬¸ì„œí™”ê°€ í•„ìš”í•œ ì‘ì—…

**ì‘ë‹µ ì˜ˆì‹œ**:
```markdown
# ë¶„ì„ ë³´ê³ ì„œ

**ìƒì„± ì¼ì‹œ**: 2025-11-03 14:30:00

## ğŸ“‹ ìš”ì•½
íŒŒì´ì¬ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì— ëŒ€í•œ ì„¤ëª…...

## ğŸ“Š ì‹¤í–‰ í†µê³„
| í•­ëª© | ìˆ˜ì¹˜ |
|------|------|
| ì´ ì‹¤í–‰ ë‹¨ê³„ | 3ê°œ |
| ì™„ë£Œëœ ë‹¨ê³„ | 3ê°œ |

## ğŸ” ìƒì„¸ ì‹¤í–‰ ë‚´ì—­
### âœ… Step 1: ì •ë³´ ê²€ìƒ‰
- **Agent**: ğŸ” `search`
- **ìƒíƒœ**: completed
```

---

### ì¶œë ¥ í˜•ì‹ ì„ íƒ ë°©ë²•

**WebSocketì—ì„œ ì¶œë ¥ í˜•ì‹ ì§€ì •**:
```javascript
// ë©”ì‹œì§€ ì „ì†¡ ì‹œ output_format ì§€ì •
ws.send(JSON.stringify({
  message: 'íŒŒì´ì¬ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”',
  output_format: 'chat'  // 'chat', 'graph', ë˜ëŠ” 'report'
}));
```

**Pythonì—ì„œ ì¶œë ¥ í˜•ì‹ ì§€ì •**:
```python
message = {
    "message": "íŒŒì´ì¬ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”",
    "output_format": "report"
}
await websocket.send(json.dumps(message))
```

**ìƒëµ ì‹œ ê¸°ë³¸ê°’**: `output_format`ì„ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ `"chat"` í˜•ì‹ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.

---

## REST API ì‚¬ìš©

### 1. ê°„ë‹¨í•œ ì±„íŒ…

```bash
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "ì•ˆë…•í•˜ì„¸ìš”"}'
```

**ì‘ë‹µ**:
```json
{
  "response": "[ìµœì¢… ì‘ë‹µ] ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?"
}
```

---

### 2. ì •ë³´ ê²€ìƒ‰ ìš”ì²­

```bash
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "íŒŒì´ì¬ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”"}'
```

**ì²˜ë¦¬ ê³¼ì •**:
1. Intent Understanding: ì •ë³´ ê²€ìƒ‰ ìš”ì²­ìœ¼ë¡œ ë¶„ë¥˜
2. Planning: Search Agent í• ë‹¹
3. Search Agent: ê´€ë ¨ ì •ë³´ ê²€ìƒ‰
4. Aggregator: ìµœì¢… ì‘ë‹µ ìƒì„±

---

### 3. ê³„ì•½ì„œ ì‘ì„± (HITL í¬í•¨)

```bash
# 1ë‹¨ê³„: ê³„ì•½ì„œ ì‘ì„± ìš”ì²­
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "ê°„ë‹¨í•œ ê³„ì•½ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”"}'
```

ì´ ìš”ì²­ì€ HITLì´ í•„ìš”í•œ ê²½ìš° `interrupt`ê°€ ë°œìƒí•©ë‹ˆë‹¤. REST APIì˜ ê²½ìš° ì„¸ì…˜ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ì¬ê°œ APIë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

---

## WebSocket ì‚¬ìš©

WebSocketì„ ì‚¬ìš©í•˜ë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—ì´ì „íŠ¸ì˜ ì‹¤í–‰ ê³¼ì •ì„ ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Python ì˜ˆì œ

```python
import asyncio
import websockets
import json

async def chat_with_bot():
    uri = "ws://localhost:8000/ws/my_session_001"

    async with websockets.connect(uri) as websocket:
        print("âœ“ WebSocket ì—°ê²°ë¨")

        # ë©”ì‹œì§€ ì „ì†¡ (output_format ì§€ì • ê°€ëŠ¥)
        message = {
            "message": "ì•ˆë…•í•˜ì„¸ìš”, ê³„ì•½ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”",
            "output_format": "chat"  # 'chat', 'graph', ë˜ëŠ” 'report'
        }
        await websocket.send(json.dumps(message))
        print(f"â†’ ì „ì†¡: {message['message']}")

        # ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ìˆ˜ì‹ 
        async for raw_message in websocket:
            data = json.loads(raw_message)

            # ì—°ê²° í™•ì¸
            if data.get("type") == "connection":
                print(f"âœ“ ì„¸ì…˜ ID: {data['session_id']}")

            # ë…¸ë“œ ì‹œì‘
            elif data.get("event") == "on_chain_start":
                print(f"â–¶ {data['node']} ì‹œì‘")

            # ë…¸ë“œ ì™„ë£Œ
            elif data.get("event") == "on_chain_end":
                print(f"âœ“ {data['node']} ì™„ë£Œ")

            # HITL ìš”ì²­
            elif data.get("type") == "hitl_request":
                print(f"\nâš  [ìŠ¹ì¸ í•„ìš”] {data['message']}")

                # ì‚¬ìš©ì ì…ë ¥
                user_input = input("ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")

                # ì‘ë‹µ ì „ì†¡
                response = {
                    "type": "human_response",
                    "approve": user_input.lower() == 'y'
                }
                await websocket.send(json.dumps(response))

            # ìµœì¢… ì‘ë‹µ
            elif data.get("type") == "final":
                output_format = data.get("output_format", "chat")

                if output_format == "chat":
                    print(f"\nâœ“ [ìµœì¢… ì‘ë‹µ]\n{data['content']}")
                elif output_format == "graph":
                    print(f"\nâœ“ [ê·¸ë˜í”„ ë°ì´í„°]\n{json.dumps(data['content'], indent=2)}")
                elif output_format == "report":
                    print(f"\nâœ“ [ë³´ê³ ì„œ]\n{data['content']}")
                break

            # ì—ëŸ¬
            elif data.get("type") == "error":
                print(f"âœ— ì—ëŸ¬: {data['error']}")
                break

# ì‹¤í–‰
asyncio.run(chat_with_bot())
```

### JavaScript ì˜ˆì œ

```javascript
const ws = new WebSocket('ws://localhost:8000/ws/my_session_001');

ws.onopen = () => {
  console.log('âœ“ WebSocket ì—°ê²°ë¨');

  // ë©”ì‹œì§€ ì „ì†¡ (output_format ì§€ì • ê°€ëŠ¥)
  ws.send(JSON.stringify({
    message: 'ì•ˆë…•í•˜ì„¸ìš”, ê³„ì•½ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”',
    output_format: 'chat'  // 'chat', 'graph', ë˜ëŠ” 'report'
  }));
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);

  switch (data.type) {
    case 'connection':
      console.log(`âœ“ ì„¸ì…˜ ID: ${data.session_id}`);
      break;

    case 'hitl_request':
      console.log(`âš  [ìŠ¹ì¸ í•„ìš”] ${data.message}`);

      // ì‚¬ìš©ì í™•ì¸ (ì‹¤ì œë¡œëŠ” UIë¡œ ì²˜ë¦¬)
      const approve = confirm('ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
      ws.send(JSON.stringify({
        type: 'human_response',
        approve: approve
      }));
      break;

    case 'final':
      const outputFormat = data.output_format || 'chat';

      if (outputFormat === 'chat') {
        console.log(`âœ“ [ìµœì¢… ì‘ë‹µ]\n${data.content}`);
      } else if (outputFormat === 'graph') {
        console.log('âœ“ [ê·¸ë˜í”„ ë°ì´í„°]', data.content);
        // ì‹¤ì œ ì‚¬ìš© ì‹œ: renderGraph(data.content.nodes, data.content.edges);
      } else if (outputFormat === 'report') {
        console.log(`âœ“ [ë³´ê³ ì„œ]\n${data.content}`);
        // ì‹¤ì œ ì‚¬ìš© ì‹œ: renderMarkdown(data.content);
      }

      ws.close();
      break;

    case 'error':
      console.error(`âœ— ì—ëŸ¬: ${data.error}`);
      ws.close();
      break;
  }

  // ì´ë²¤íŠ¸ ì²˜ë¦¬
  if (data.event === 'on_chain_start') {
    console.log(`â–¶ ${data.node} ì‹œì‘`);
  } else if (data.event === 'on_chain_end') {
    console.log(`âœ“ ${data.node} ì™„ë£Œ`);
  }
};

ws.onerror = (error) => {
  console.error('WebSocket ì—ëŸ¬:', error);
};

ws.onclose = () => {
  console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
};
```

---

## ì„¸ì…˜ ID í˜•ì‹

ì„¸ì…˜ ID(thread_id)ëŠ” ê° ëŒ€í™” ì„¸ì…˜ì„ ê³ ìœ í•˜ê²Œ ì‹ë³„í•˜ëŠ” ë¬¸ìì—´ì…ë‹ˆë‹¤.

### ì§€ì›ë˜ëŠ” í˜•ì‹

**1. UUID í˜•ì‹ (ê¶Œì¥)**
```
550e8400-e29b-41d4-a716-446655440000
```
- ì „ì—­ì ìœ¼ë¡œ ê³ ìœ í•œ ID ë³´ì¥
- ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•˜ì—¬ ë³´ì•ˆì— ìœ ë¦¬
- ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ì•ˆì „

**2. ìë™ ìƒì„± í˜•ì‹**
```
thread_1a2b3c4d5e6f7g8h
```
- `SessionManager.create_session()` í˜¸ì¶œ ì‹œ ìë™ ìƒì„±
- `thread_` ì ‘ë‘ì‚¬ + UUID ì• 16ì

**3. ì»¤ìŠ¤í…€ ë¬¸ìì—´**
```
my_session_001
user_123_session
```
- ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ í¸ë¦¬
- ìš´ì˜ í™˜ê²½ì—ì„œëŠ” UUID ê¶Œì¥

### ì‚¬ìš© ì˜ˆì œ

**Pythonì—ì„œ UUID ìƒì„±:**
```python
import uuid

# ìˆœìˆ˜ UUID ì‚¬ìš©
session_id = str(uuid.uuid4())
# ê²°ê³¼: "550e8400-e29b-41d4-a716-446655440000"

# WebSocket ì—°ê²°
uri = f"ws://localhost:8000/ws/chat/{session_id}"
```

**JavaScriptì—ì„œ UUID ìƒì„±:**
```javascript
// crypto API ì‚¬ìš© (Node.js 15+)
import { randomUUID } from 'crypto';
const sessionId = randomUUID();

// ë˜ëŠ” uuid íŒ¨í‚¤ì§€ ì‚¬ìš©
import { v4 as uuidv4 } from 'uuid';
const sessionId = uuidv4();

// WebSocket ì—°ê²°
const ws = new WebSocket(`ws://localhost:8000/ws/chat/${sessionId}`);
```

**curlì—ì„œ UUID ì‚¬ìš©:**
```bash
# uuidgen ëª…ë ¹ (Linux/macOS)
SESSION_ID=$(uuidgen)
curl http://localhost:8000/api/sessions/$SESSION_ID

# PowerShell (Windows)
$SESSION_ID = [guid]::NewGuid().ToString()
curl http://localhost:8000/api/sessions/$SESSION_ID
```

### ì£¼ì˜ì‚¬í•­

- **stateless /chat ì—”ë“œí¬ì¸íŠ¸**: í˜„ì¬ `/chat` POST ì—”ë“œí¬ì¸íŠ¸ëŠ” ì„¸ì…˜ ê´€ë¦¬ë¥¼ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¸ì…˜ ê¸°ë°˜ ëŒ€í™”ë¥¼ ì›í•˜ë©´ WebSocketì„ ì‚¬ìš©í•˜ì„¸ìš”.
- **ì„¸ì…˜ ID ì¬ì‚¬ìš©**: ê°™ì€ thread_idë¡œ ì¬ì ‘ì†í•˜ë©´ ì´ì „ ëŒ€í™” ë‚´ìš©ì´ ë³µì›ë©ë‹ˆë‹¤.
- **ì„¸ì…˜ ë§Œë£Œ**: í˜„ì¬ ì„¸ì…˜ ë§Œë£Œ ê¸°ëŠ¥ì€ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•´ì•¼ í•©ë‹ˆë‹¤.

---

## ì„¸ì…˜ ê´€ë¦¬

### 1. ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ

```bash
curl http://localhost:8000/api/sessions
```

**ì‘ë‹µ**:
```json
{
  "sessions": [
    {
      "thread_id": "my_session_001",
      "user_id": "user_123",
      "status": "active",
      "created_at": "2025-11-03T10:00:00Z",
      "updated_at": "2025-11-03T10:30:00Z"
    }
  ],
  "total": 1
}
```

---

### 2. íŠ¹ì • ì„¸ì…˜ ìƒíƒœ ì¡°íšŒ

```bash
curl http://localhost:8000/api/sessions/my_session_001
```

**ì‘ë‹µ**:
```json
{
  "thread_id": "my_session_001",
  "status": "completed",
  "state": {
    "messages": [...],
    "user_intent": {...},
    "plan": {...},
    "final_result": "ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"
  },
  "checkpoint_id": "1f0b8754-d0c9-63cd-801c-aaa11472b0f5"
}
```

**ìƒíƒœ ê°’**:
- `waiting_human`: HITL ìŠ¹ì¸ ëŒ€ê¸° ì¤‘
- `in_progress`: ì‹¤í–‰ ì¤‘
- `completed`: ì™„ë£Œë¨

---

### 3. ì„¸ì…˜ íˆìŠ¤í† ë¦¬ ì¡°íšŒ

```bash
curl http://localhost:8000/api/sessions/my_session_001/history?limit=10
```

**ì‘ë‹µ**:
```json
{
  "thread_id": "my_session_001",
  "total_messages": 18,
  "returned_messages": 10,
  "messages": [
    {
      "type": "HumanMessage",
      "content": "ì•ˆë…•í•˜ì„¸ìš”"
    },
    {
      "type": "AIMessage",
      "content": "[Intent Understanding] ì‚¬ìš©ì ìš”ì²­ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤..."
    }
  ]
}
```

---

### 4. ì²´í¬í¬ì¸íŠ¸ ì¡°íšŒ

```bash
curl http://localhost:8000/api/sessions/my_session_001/checkpoints
```

**ì‘ë‹µ**:
```json
{
  "checkpoints": [
    {
      "checkpoint_id": "1f0b8755-c593-66...",
      "thread_id": "my_session_001",
      "checkpoint_ns": "",
      "step": 0
    },
    {
      "checkpoint_id": "1f0b8755-c590-6f...",
      "thread_id": "my_session_001",
      "checkpoint_ns": "",
      "step": 1
    }
  ],
  "total": 30
}
```

---

### 5. ì„¸ì…˜ ì‚­ì œ

```bash
curl -X DELETE http://localhost:8000/api/sessions/my_session_001
```

**ì‘ë‹µ**:
```json
{
  "message": "Session my_session_001 deleted successfully"
}
```

---

## HITL ì²˜ë¦¬

HITL (Human-in-the-Loop)ì€ ì¤‘ìš”í•œ ì‘ì—…ì—ì„œ ì‚¬ëŒì˜ ìŠ¹ì¸ì„ ìš”êµ¬í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### HITLì´ í•„ìš”í•œ ì‘ì—…

- ê³„ì•½ì„œ ì‘ì„±
- ê²°ì œ ì²˜ë¦¬
- ë¯¼ê°í•œ ë°ì´í„° ì²˜ë¦¬
- ì¤‘ìš”í•œ ì„¤ì • ë³€ê²½

### REST API ë°©ì‹

#### 1ë‹¨ê³„: ì‘ì—… ìš”ì²­ (HITL ë°œìƒ)

```bash
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "ê³„ì•½ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”"}'
```

ì‘ì—…ì´ HITL ë‹¨ê³„ì— ë„ë‹¬í•˜ë©´ `interrupt`ê°€ ë°œìƒí•˜ê³  ì„¸ì…˜ì´ `waiting_human` ìƒíƒœê°€ ë©ë‹ˆë‹¤.

#### 2ë‹¨ê³„: ì„¸ì…˜ ìƒíƒœ í™•ì¸

```bash
curl http://localhost:8000/api/sessions/contract_session_001
```

**ì‘ë‹µ**:
```json
{
  "thread_id": "contract_session_001",
  "status": "waiting_human",
  "state": {
    "is_waiting_human": true,
    ...
  }
}
```

#### 3ë‹¨ê³„: ì„¸ì…˜ ì¬ê°œ

**ìë™ ìŠ¹ì¸**:
```bash
curl -X POST http://localhost:8000/api/sessions/contract_session_001/resume \
  -H "Content-Type: application/json" \
  -d '{"approve": true}'
```

**í”¼ë“œë°±ê³¼ í•¨ê»˜ ì¬ê°œ**:
```bash
curl -X POST http://localhost:8000/api/sessions/contract_session_001/resume \
  -H "Content-Type: application/json" \
  -d '{"response": "ê³„ì•½ ê¸ˆì•¡ì„ 1000ë§Œì›ìœ¼ë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”"}'
```

---

### WebSocket ë°©ì‹

WebSocketì„ ì‚¬ìš©í•˜ë©´ HITLì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
async def handle_hitl():
    async with websockets.connect(uri) as ws:
        # ë©”ì‹œì§€ ì „ì†¡
        await ws.send(json.dumps({
            "message": "ê³„ì•½ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”",
            "output_format": "report"  # ê³„ì•½ì„œëŠ” ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ
        }))

        # ìŠ¤íŠ¸ë¦¬ë° ìˆ˜ì‹ 
        async for message in ws:
            data = json.loads(message)

            if data.get("type") == "hitl_request":
                print(f"ìŠ¹ì¸ ìš”ì²­: {data['message']}")

                # ìŠ¹ì¸ ë˜ëŠ” ê±°ë¶€
                user_choice = input("ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")

                await ws.send(json.dumps({
                    "type": "human_response",
                    "approve": user_choice.lower() == 'y'
                }))

            elif data.get("type") == "final":
                print(f"ì™„ë£Œ: {data['content']}")
                break
```

---

## ë¬¸ì œ í•´ê²°

### 1. ì„œë²„ê°€ ì‹œì‘ë˜ì§€ ì•ŠìŒ

**ë¬¸ì œ**: `POSTGRES_URL í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤`

**í•´ê²°**:
- `.env` íŒŒì¼ì— `POSTGRES_URL`ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
- PostgreSQL ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸

```bash
# PostgreSQL ì—°ê²° í…ŒìŠ¤íŠ¸
psql -h localhost -U postgres -d octo_chatbot
```

---

### 2. OpenAI API ì—ëŸ¬

**ë¬¸ì œ**: `AuthenticationError: Incorrect API key`

**í•´ê²°**:
- `.env` íŒŒì¼ì˜ `OPENAI_API_KEY`ê°€ ìœ íš¨í•œì§€ í™•ì¸
- OpenAI ê³„ì •ì—ì„œ API í‚¤ë¥¼ ì¬ìƒì„±í•˜ì—¬ ì—…ë°ì´íŠ¸

---

### 3. WebSocket ì—°ê²° ì‹¤íŒ¨

**ë¬¸ì œ**: `WebSocket connection failed`

**í•´ê²°**:
- ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
- ë°©í™”ë²½ ì„¤ì • í™•ì¸
- CORS ì„¤ì • í™•ì¸ (`.env`ì˜ `SYSTEM_ALLOWED_ORIGINS`)

---

### 4. HITL ì„¸ì…˜ì´ ì‘ë‹µí•˜ì§€ ì•ŠìŒ

**ë¬¸ì œ**: ì„¸ì…˜ì´ `waiting_human` ìƒíƒœì—ì„œ ë©ˆì¶¤

**í•´ê²°**:
- `/api/sessions/{thread_id}/resume` ì—”ë“œí¬ì¸íŠ¸ë¡œ ì„¸ì…˜ ì¬ê°œ
- ë˜ëŠ” ì„¸ì…˜ì„ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ì‹œì‘

```bash
# ì„¸ì…˜ ì¬ê°œ
curl -X POST http://localhost:8000/api/sessions/{thread_id}/resume \
  -H "Content-Type: application/json" \
  -d '{"approve": true}'

# ë˜ëŠ” ì„¸ì…˜ ì‚­ì œ
curl -X DELETE http://localhost:8000/api/sessions/{thread_id}
```

---

### 5. ì²´í¬í¬ì¸íŠ¸ ì¡°íšŒ ì‹¤íŒ¨

**ë¬¸ì œ**: `500 Internal Server Error`

**í•´ê²°**:
- PostgreSQL ì—°ê²° í™•ì¸
- `checkpoints` í…Œì´ë¸”ì´ ìƒì„±ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

```sql
-- PostgreSQLì—ì„œ í™•ì¸
\dt checkpoints
SELECT COUNT(*) FROM checkpoints;
```

---

## ë‹¤ìŒ ë‹¨ê³„

- [API ëª…ì„¸ì„œ](./API_ëª…ì„¸ì„œ_251103.md)ì—ì„œ ì „ì²´ API í™•ì¸
- [ê°œë°œì ê°€ì´ë“œ](./ê°œë°œì_ê°€ì´ë“œ_251103.md)ì—ì„œ ì»¤ìŠ¤í„°ë§ˆì´ì§• ë°©ë²• í™•ì¸
- [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ëª…ì„¸ì„œ](./ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜_ëª…ì„¸ì„œ_251103.md)ì—ì„œ ì‹œìŠ¤í…œ êµ¬ì¡° ì´í•´

---

## ì§€ì›

ë¬¸ì œê°€ ë°œìƒí•˜ê±°ë‚˜ ì§ˆë¬¸ì´ ìˆìœ¼ì‹  ê²½ìš°:
- GitHub Issuesì— ë¬¸ì˜
- ê°œë°œì ê°€ì´ë“œì˜ ë¬¸ì œ í•´ê²° ì„¹ì…˜ ì°¸ì¡°
