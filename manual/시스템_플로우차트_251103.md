# 시스템 플로우차트

**작성일**: 2025-11-03
**버전**: 0.4.0

---

## 목차

1. [전체 시스템 플로우](#전체-시스템-플로우)
2. [REST API 플로우](#rest-api-플로우)
3. [WebSocket API 플로우](#websocket-api-플로우)
4. [HITL 플로우](#hitl-플로우)
5. [세션 관리 플로우](#세션-관리-플로우)

---

## 전체 시스템 플로우

```mermaid
graph TB
    Start([사용자 요청]) --> APIChoice{API 선택}

    APIChoice -->|REST API| RestAPI[REST API 엔드포인트]
    APIChoice -->|WebSocket| WSConnect[WebSocket 연결]

    RestAPI --> SessionCheck{세션<br/>존재?}
    WSConnect --> WSSessionCheck{세션<br/>존재?}

    SessionCheck -->|Yes| LoadSession[세션 로드]
    SessionCheck -->|No| CreateSession[새 세션 생성]
    WSSessionCheck -->|Yes| WSLoadSession[세션 로드]
    WSSessionCheck -->|No| WSCreateSession[새 세션 생성]

    LoadSession --> ProcessRequest
    CreateSession --> ProcessRequest
    WSLoadSession --> ProcessRequest
    WSCreateSession --> ProcessRequest

    ProcessRequest[Supervisor Graph 실행] --> IntentNode[Intent Understanding]

    IntentNode --> PlanningNode[Planning]

    PlanningNode --> RouterNode[Router]

    RouterNode --> HITLCheck{HITL<br/>필요?}

    HITLCheck -->|Yes| Interrupt[interrupt 호출]
    HITLCheck -->|No| AgentExec[Agent 실행]

    Interrupt --> WaitHuman[사용자 승인 대기]
    WaitHuman --> HumanResp{사용자<br/>응답}

    HumanResp -->|승인| AgentExec
    HumanResp -->|거부| ErrorResp[에러 응답]
    HumanResp -->|수정 요청| ModifyPlan[계획 수정]

    ModifyPlan --> AgentExec

    AgentExec --> AgentType{Agent<br/>타입}

    AgentType -->|Search| SearchAgent[Search Agent]
    AgentType -->|Web| WebAgent[Web Agent]
    AgentType -->|Contract| ContractAgent[Contract Agent]
    AgentType -->|Code| CodeAgent[Code Agent]
    AgentType -->|Data| DataAgent[Data Agent]

    SearchAgent --> SaveCheckpoint
    WebAgent --> SaveCheckpoint
    ContractAgent --> SaveCheckpoint
    CodeAgent --> SaveCheckpoint
    DataAgent --> SaveCheckpoint

    SaveCheckpoint[Checkpoint 저장<br/>PostgreSQL] --> MoreSteps{더 많은<br/>단계?}

    MoreSteps -->|Yes| RouterNode
    MoreSteps -->|No| AggregatorNode[Aggregator]

    AggregatorNode --> FinalResult[최종 응답 생성]

    FinalResult --> ResponseType{응답<br/>타입}

    ResponseType -->|REST| RestResponse[JSON 응답]
    ResponseType -->|WebSocket| WSResponse[WebSocket 메시지]

    RestResponse --> End([종료])
    WSResponse --> End
    ErrorResp --> End

    style Start fill:#e1f5e1
    style End fill:#ffe1e1
    style HITLCheck fill:#fff4e1
    style Interrupt fill:#ffe1e1
    style SaveCheckpoint fill:#e1f0ff
```

---

## REST API 플로우

### 1. 채팅 메시지 처리 (POST /chat)

```mermaid
sequenceDiagram
    participant Client
    participant FastAPI
    participant SupervisorGraph
    participant PostgreSQL
    participant OpenAI

    Client->>FastAPI: POST /chat
    activate FastAPI

    FastAPI->>SupervisorGraph: ainvoke(message)
    activate SupervisorGraph

    SupervisorGraph->>PostgreSQL: 세션 상태 로드
    PostgreSQL-->>SupervisorGraph: 기존 상태 반환

    SupervisorGraph->>SupervisorGraph: Intent Understanding
    SupervisorGraph->>PostgreSQL: Checkpoint 저장

    SupervisorGraph->>SupervisorGraph: Planning
    SupervisorGraph->>PostgreSQL: Checkpoint 저장

    SupervisorGraph->>SupervisorGraph: Router

    alt HITL 필요
        SupervisorGraph->>SupervisorGraph: interrupt()
        SupervisorGraph->>PostgreSQL: HITL 상태 저장
        SupervisorGraph-->>FastAPI: 대기 상태
        FastAPI-->>Client: 409 Conflict (HITL 필요)
    else HITL 불필요
        SupervisorGraph->>OpenAI: Agent 실행
        OpenAI-->>SupervisorGraph: Agent 응답

        SupervisorGraph->>PostgreSQL: Checkpoint 저장

        SupervisorGraph->>SupervisorGraph: Aggregator
        SupervisorGraph->>PostgreSQL: 최종 상태 저장

        SupervisorGraph-->>FastAPI: 최종 응답
        deactivate SupervisorGraph

        FastAPI-->>Client: 200 OK + 응답
        deactivate FastAPI
    end
```

---

### 2. 세션 상태 조회 (GET /api/sessions/{thread_id})

```mermaid
sequenceDiagram
    participant Client
    participant FastAPI
    participant SessionManager
    participant PostgreSQL
    participant SupervisorGraph

    Client->>FastAPI: GET /api/sessions/{thread_id}
    activate FastAPI

    FastAPI->>PostgreSQL: create_checkpointer()
    PostgreSQL-->>FastAPI: Checkpointer

    FastAPI->>SupervisorGraph: build_supervisor_graph()
    SupervisorGraph-->>FastAPI: Graph

    FastAPI->>SupervisorGraph: aget_state(config)
    activate SupervisorGraph

    SupervisorGraph->>PostgreSQL: 최신 checkpoint 조회
    PostgreSQL-->>SupervisorGraph: Checkpoint 데이터

    SupervisorGraph-->>FastAPI: State
    deactivate SupervisorGraph

    FastAPI->>FastAPI: 상태 분석<br/>(waiting_human/in_progress/completed)

    FastAPI-->>Client: 200 OK + SessionStateResponse
    deactivate FastAPI
```

---

### 3. HITL 재개 (POST /api/sessions/{thread_id}/resume)

```mermaid
sequenceDiagram
    participant Client
    participant FastAPI
    participant SupervisorGraph
    participant PostgreSQL
    participant OpenAI

    Client->>FastAPI: POST /api/sessions/{thread_id}/resume
    Note over Client,FastAPI: {approve: true} 또는<br/>{response: "..."}
    activate FastAPI

    FastAPI->>SupervisorGraph: aget_state(config)
    activate SupervisorGraph

    SupervisorGraph->>PostgreSQL: 현재 상태 조회
    PostgreSQL-->>SupervisorGraph: State (waiting_human)

    SupervisorGraph-->>FastAPI: Current State
    deactivate SupervisorGraph

    FastAPI->>FastAPI: is_waiting_human 확인

    alt approve: true
        FastAPI->>SupervisorGraph: ainvoke(None, config)
        Note over SupervisorGraph: 자동 승인
    else response: "..."
        FastAPI->>SupervisorGraph: ainvoke(Command(resume=response))
        Note over SupervisorGraph: 사용자 피드백 포함
    end

    activate SupervisorGraph
    SupervisorGraph->>OpenAI: Agent 실행 재개
    OpenAI-->>SupervisorGraph: 응답

    SupervisorGraph->>PostgreSQL: Checkpoint 저장

    SupervisorGraph->>SupervisorGraph: 나머지 단계 실행
    SupervisorGraph->>PostgreSQL: 최종 상태 저장

    SupervisorGraph-->>FastAPI: 최종 결과
    deactivate SupervisorGraph

    FastAPI-->>Client: 200 OK + ResumeResponse
    deactivate FastAPI
```

---

## WebSocket API 플로우

```mermaid
sequenceDiagram
    participant Client
    participant WebSocket
    participant SessionManager
    participant SupervisorGraph
    participant PostgreSQL
    participant OpenAI

    Client->>WebSocket: WS 연결 요청
    activate WebSocket

    WebSocket->>SessionManager: 세션 생성/로드
    SessionManager-->>WebSocket: Session Config

    WebSocket-->>Client: 연결 확인 메시지

    Client->>WebSocket: {"type": "message", "content": "..."}

    WebSocket->>SupervisorGraph: astream_events()
    activate SupervisorGraph

    loop 각 노드 실행
        SupervisorGraph->>PostgreSQL: Checkpoint 저장
        SupervisorGraph-->>WebSocket: on_chain_start
        WebSocket-->>Client: 노드 시작 이벤트

        SupervisorGraph->>OpenAI: LLM 호출
        OpenAI-->>SupervisorGraph: 응답

        SupervisorGraph-->>WebSocket: on_chain_end
        WebSocket-->>Client: 노드 완료 이벤트

        alt HITL 필요
            SupervisorGraph->>SupervisorGraph: interrupt()
            SupervisorGraph->>PostgreSQL: HITL 상태 저장
            SupervisorGraph-->>WebSocket: HITL 요청
            WebSocket-->>Client: {"type": "hitl_request"}

            Client->>WebSocket: {"type": "human_response"}
            WebSocket->>SupervisorGraph: Command(resume=...)
            SupervisorGraph->>SupervisorGraph: 실행 재개
        end
    end

    SupervisorGraph->>PostgreSQL: 최종 상태 저장
    SupervisorGraph-->>WebSocket: 최종 응답
    deactivate SupervisorGraph

    WebSocket-->>Client: {"type": "final", "content": "..."}

    Client->>WebSocket: 연결 종료
    deactivate WebSocket
```

---

## HITL 플로우

```mermaid
graph TB
    Start([Router Node]) --> CheckStep[현재 단계 확인]

    CheckStep --> IsHITL{HITL 필요<br/>단계?}

    IsHITL -->|No| ExecuteAgent[Agent 실행]
    IsHITL -->|Yes| CheckCategory{카테고리<br/>확인}

    CheckCategory -->|contract| HITLNeeded[HITL 필요]
    CheckCategory -->|payment| HITLNeeded
    CheckCategory -->|sensitive| HITLNeeded
    CheckCategory -->|기타| ExecuteAgent

    HITLNeeded --> SetWaitingFlag[is_waiting_human = True]

    SetWaitingFlag --> Interrupt[interrupt 호출]

    Interrupt --> SaveState[상태 저장<br/>PostgreSQL]

    SaveState --> WaitUser[사용자 입력 대기]

    WaitUser --> UserAction{사용자<br/>행동}

    UserAction -->|승인| ResumeNone[ainvoke None, config]
    UserAction -->|거부| Abort[작업 중단]
    UserAction -->|수정| ResumeResponse[ainvoke Command resume]

    ResumeNone --> ClearFlag[is_waiting_human = False]
    ResumeResponse --> ClearFlag

    ClearFlag --> ExecuteAgent

    ExecuteAgent --> NextStep[다음 단계]
    Abort --> End([종료])
    NextStep --> End

    style Start fill:#e1f5e1
    style Interrupt fill:#ffe1e1
    style WaitUser fill:#fff4e1
    style SaveState fill:#e1f0ff
```

---

## 세션 관리 플로우

### 세션 생성 및 체크포인트 관리

```mermaid
graph TB
    Start([요청 시작]) --> HasThreadID{thread_id<br/>제공?}

    HasThreadID -->|Yes| LoadCheckpoint[Checkpoint 로드]
    HasThreadID -->|No| GenerateID[thread_id 생성]

    GenerateID --> CreateSession[새 세션 생성]

    LoadCheckpoint --> CheckpointExists{Checkpoint<br/>존재?}

    CheckpointExists -->|Yes| RestoreState[상태 복원]
    CheckpointExists -->|No| InitState[초기 상태 생성]

    CreateSession --> InitState

    RestoreState --> ExecuteGraph[Graph 실행]
    InitState --> ExecuteGraph

    ExecuteGraph --> NodeExec[Node 실행]

    NodeExec --> SaveCP[Checkpoint 저장]

    SaveCP --> DBWrite[(PostgreSQL<br/>Write)]

    DBWrite --> MoreNodes{더 많은<br/>노드?}

    MoreNodes -->|Yes| NodeExec
    MoreNodes -->|No| FinalSave[최종 상태 저장]

    FinalSave --> FinalDB[(PostgreSQL<br/>Final Write)]

    FinalDB --> UpdateSession[SessionManager<br/>업데이트]

    UpdateSession --> End([완료])

    style Start fill:#e1f5e1
    style SaveCP fill:#e1f0ff
    style DBWrite fill:#e1f0ff
    style FinalDB fill:#e1f0ff
```

---

### Checkpoint 조회 플로우

```mermaid
sequenceDiagram
    participant Client
    participant API
    participant Checkpointer
    participant PostgreSQL

    Client->>API: GET /api/sessions/{thread_id}/checkpoints
    activate API

    API->>Checkpointer: create_checkpointer()
    activate Checkpointer
    Checkpointer-->>API: AsyncPostgresSaver
    deactivate Checkpointer

    API->>Checkpointer: alist(config)
    activate Checkpointer

    Checkpointer->>PostgreSQL: SELECT * FROM checkpoints<br/>WHERE thread_id = ?<br/>ORDER BY checkpoint_id
    activate PostgreSQL

    loop 각 Checkpoint
        PostgreSQL-->>Checkpointer: Checkpoint Row
        Checkpointer->>Checkpointer: CheckpointTuple 생성
        Checkpointer-->>API: yield CheckpointTuple
        API->>API: CheckpointInfo 추가
    end

    deactivate PostgreSQL
    deactivate Checkpointer

    API-->>Client: CheckpointListResponse
    deactivate API
```

---

## 데이터 플로우

```mermaid
graph LR
    subgraph Client Layer
        REST[REST Client]
        WS[WebSocket Client]
    end

    subgraph API Layer
        FastAPI[FastAPI Server]
    end

    subgraph Application Layer
        SG[Supervisor Graph]
        SM[Session Manager]
        CM[Checkpointer Manager]
    end

    subgraph Data Layer
        PG[(PostgreSQL)]
    end

    subgraph External
        OpenAI[OpenAI API]
    end

    REST -->|HTTP| FastAPI
    WS -->|WebSocket| FastAPI

    FastAPI -->|ainvoke/astream| SG
    FastAPI -->|세션 관리| SM

    SG -->|상태 저장| CM
    SM -->|메타데이터| CM

    CM -->|SQL| PG

    SG -->|LLM 호출| OpenAI

    PG -.->|상태 로드| CM
    CM -.->|State| SG

    style PG fill:#e1f0ff
    style OpenAI fill:#ffe1e1
```

---

## 참조

- [시스템 아키텍처 명세서](./시스템_아키텍처_명세서_251103.md)
- [에이전트 플로우차트](./에이전트_플로우차트_251103.md)
- [API 명세서](./API_명세서_251103.md)
