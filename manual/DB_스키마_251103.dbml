// Octo Worker Database Schema
// Version: 0.4.0
// Date: 2025-11-03
// Database: PostgreSQL 13+

// ì´ íŒŒì¼ì„ dbdiagram.ioì—ì„œ ì—´ì–´ì„œ ì‹œê°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
// URL: https://dbdiagram.io/d

Project OctoWorker {
  database_type: 'PostgreSQL'
  Note: '''
    # Octo Worker Database Schema

    LangGraph 1.0 ê¸°ë°˜ ë©€í‹° ì—ì´ì „íŠ¸ ì±—ë´‡ ì‹œìŠ¤í…œ
    - PostgreSQL Checkpoint ì €ì¥
    - ì„¸ì…˜ ìƒíƒœ ê´€ë¦¬
    - HITL (Human-in-the-Loop) ì§€ì›
  '''
}

// ============================================
// LangGraph Checkpointer Tables
// ============================================

Table checkpoints {
  thread_id varchar(255) [not null, note: 'ì„¸ì…˜ ì‹ë³„ì (session_idì™€ ë™ì¼)']
  checkpoint_ns varchar(255) [not null, default: '', note: 'ì²´í¬í¬ì¸íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤']
  checkpoint_id varchar(255) [not null, note: 'ì²´í¬í¬ì¸íŠ¸ ê³ ìœ  ID (UUID)']
  parent_checkpoint_id varchar(255) [note: 'ë¶€ëª¨ ì²´í¬í¬ì¸íŠ¸ ID']
  type varchar(50) [note: 'ì²´í¬í¬ì¸íŠ¸ íƒ€ì…']
  checkpoint bytea [not null, note: 'ìƒíƒœ ë°ì´í„° (ì§ë ¬í™”ëœ Python ê°ì²´)']
  metadata bytea [note: 'ë©”íƒ€ë°ì´í„° (ì§ë ¬í™”ëœ ë”•ì…”ë„ˆë¦¬)']
  created_at timestamp [default: `now()`, note: 'ìƒì„± ì‹œê°„']

  indexes {
    (thread_id, checkpoint_ns, checkpoint_id) [pk]
    thread_id [name: 'idx_checkpoints_thread_id']
    checkpoint_id [name: 'idx_checkpoints_checkpoint_id']
    created_at [name: 'idx_checkpoints_created_at']
  }

  Note: '''
    LangGraph StateGraphì˜ ì²´í¬í¬ì¸íŠ¸ ì €ì¥ì†Œ
    - ê° ë…¸ë“œ ì‹¤í–‰ í›„ ìƒíƒœ ì €ì¥
    - íƒ€ì„ íŠ¸ë˜ë¸” ë° ì„¸ì…˜ ë³µì› ì§€ì›
    - thread_idë¡œ ì„¸ì…˜ ê²©ë¦¬
  '''
}

Table checkpoint_writes {
  thread_id varchar(255) [not null, note: 'ì„¸ì…˜ ì‹ë³„ì']
  checkpoint_ns varchar(255) [not null, default: '', note: 'ì²´í¬í¬ì¸íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤']
  checkpoint_id varchar(255) [not null, note: 'ì²´í¬í¬ì¸íŠ¸ ID']
  task_id varchar(255) [not null, note: 'íƒœìŠ¤í¬ ê³ ìœ  ID']
  idx integer [not null, note: 'ì“°ê¸° ìˆœì„œ ì¸ë±ìŠ¤']
  channel varchar(255) [not null, note: 'ì±„ë„ëª… (ìƒíƒœ í‚¤)']
  type varchar(50) [note: 'ì“°ê¸° íƒ€ì… (update, replace ë“±)']
  value bytea [note: 'ì“°ê¸° ê°’ (ì§ë ¬í™”)']
  created_at timestamp [default: `now()`, note: 'ìƒì„± ì‹œê°„']

  indexes {
    (thread_id, checkpoint_ns, checkpoint_id, task_id, idx) [pk]
    thread_id [name: 'idx_writes_thread_id']
    checkpoint_id [name: 'idx_writes_checkpoint_id']
    (thread_id, checkpoint_id) [name: 'idx_writes_thread_checkpoint']
  }

  Note: '''
    ì²´í¬í¬ì¸íŠ¸ ì“°ê¸° ë¡œê·¸
    - ìƒíƒœ ë³€ê²½ ì¶”ì 
    - ì±„ë„ë³„ ê°’ ì—…ë°ì´íŠ¸ ê¸°ë¡
  '''
}

// ============================================
// Session Management Tables (Optional)
// ============================================

Table sessions {
  thread_id varchar(255) [pk, note: 'ì„¸ì…˜ ê³ ìœ  ID']
  user_id varchar(255) [note: 'ì‚¬ìš©ì ID (ì˜µì…˜)']
  status varchar(50) [not null, default: 'active', note: 'active, waiting_human, in_progress, completed, failed']
  is_waiting_human boolean [default: false, note: 'HITL ëŒ€ê¸° ìƒíƒœ']
  last_checkpoint_id varchar(255) [note: 'ë§ˆì§€ë§‰ ì²´í¬í¬ì¸íŠ¸ ID']
  session_metadata jsonb [note: 'ì„¸ì…˜ ë©”íƒ€ë°ì´í„° (JSON)']
  created_at timestamp [default: `now()`, note: 'ìƒì„± ì‹œê°„']
  updated_at timestamp [default: `now()`, note: 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„']
  expires_at timestamp [note: 'ë§Œë£Œ ì‹œê°„ (ì˜µì…˜)']

  indexes {
    user_id [name: 'idx_sessions_user_id']
    status [name: 'idx_sessions_status']
    is_waiting_human [name: 'idx_sessions_waiting_human']
    created_at [name: 'idx_sessions_created_at']
    expires_at [name: 'idx_sessions_expires_at']
  }

  Note: '''
    ì„¸ì…˜ ë©”íƒ€ë°ì´í„° ê´€ë¦¬ (í˜„ì¬ ë©”ëª¨ë¦¬ ê¸°ë°˜, ì¶”í›„ DB ì €ì¥ ê°€ëŠ¥)
    - ì„¸ì…˜ ìƒíƒœ ì¶”ì 
    - HITL ëŒ€ê¸° ìƒíƒœ ê´€ë¦¬
    - ì‚¬ìš©ìë³„ ì„¸ì…˜ ì¡°íšŒ
  '''
}

Table session_messages {
  id bigserial [pk, note: 'ë©”ì‹œì§€ ê³ ìœ  ID']
  thread_id varchar(255) [not null, ref: > sessions.thread_id, note: 'ì„¸ì…˜ ID']
  message_type varchar(50) [not null, note: 'HumanMessage, AIMessage, SystemMessage ë“±']
  content text [not null, note: 'ë©”ì‹œì§€ ë‚´ìš©']
  message_metadata jsonb [note: 'ë©”ì‹œì§€ ë©”íƒ€ë°ì´í„°']
  sequence_number integer [not null, note: 'ë©”ì‹œì§€ ìˆœì„œ']
  created_at timestamp [default: `now()`, note: 'ìƒì„± ì‹œê°„']

  indexes {
    thread_id [name: 'idx_messages_thread_id']
    (thread_id, sequence_number) [name: 'idx_messages_thread_seq']
    created_at [name: 'idx_messages_created_at']
  }

  Note: '''
    ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ (ì˜µì…˜)
    - í˜„ì¬ëŠ” checkpointì— í¬í•¨ë˜ì–´ ì €ì¥
    - ë¹ ë¥¸ íˆìŠ¤í† ë¦¬ ì¡°íšŒë¥¼ ìœ„í•´ ë¶„ë¦¬ ê°€ëŠ¥
  '''
}

// ============================================
// Agent Execution Logs (Optional)
// ============================================

Table agent_executions {
  id bigserial [pk, note: 'ì‹¤í–‰ ë¡œê·¸ ID']
  thread_id varchar(255) [not null, ref: > sessions.thread_id, note: 'ì„¸ì…˜ ID']
  checkpoint_id varchar(255) [note: 'ê´€ë ¨ ì²´í¬í¬ì¸íŠ¸ ID']
  agent_name varchar(100) [not null, note: 'ì—ì´ì „íŠ¸ ì´ë¦„ (search, web, contract ë“±)']
  node_name varchar(100) [not null, note: 'ë…¸ë“œ ì´ë¦„']
  status varchar(50) [not null, note: 'started, completed, failed, interrupted']
  input_data jsonb [note: 'ì…ë ¥ ë°ì´í„°']
  output_data jsonb [note: 'ì¶œë ¥ ë°ì´í„°']
  error_message text [note: 'ì—ëŸ¬ ë©”ì‹œì§€ (ì‹¤íŒ¨ ì‹œ)']
  execution_time_ms integer [note: 'ì‹¤í–‰ ì‹œê°„ (ë°€ë¦¬ì´ˆ)']
  started_at timestamp [not null, default: `now()`, note: 'ì‹œì‘ ì‹œê°„']
  completed_at timestamp [note: 'ì™„ë£Œ ì‹œê°„']

  indexes {
    thread_id [name: 'idx_executions_thread_id']
    agent_name [name: 'idx_executions_agent_name']
    status [name: 'idx_executions_status']
    started_at [name: 'idx_executions_started_at']
    (thread_id, started_at) [name: 'idx_executions_thread_started']
  }

  Note: '''
    ì—ì´ì „íŠ¸ ì‹¤í–‰ ë¡œê·¸ (ì˜µì…˜)
    - ëª¨ë‹ˆí„°ë§ ë° ë””ë²„ê¹…ìš©
    - ì„±ëŠ¥ ë¶„ì„
    - ì—ëŸ¬ ì¶”ì 
  '''
}

Table hitl_approvals {
  id bigserial [pk, note: 'ìŠ¹ì¸ ìš”ì²­ ID']
  thread_id varchar(255) [not null, ref: > sessions.thread_id, note: 'ì„¸ì…˜ ID']
  checkpoint_id varchar(255) [not null, note: 'ì²´í¬í¬ì¸íŠ¸ ID']
  agent_name varchar(100) [note: 'HITLì„ ìš”ì²­í•œ ì—ì´ì „íŠ¸']
  approval_type varchar(50) [not null, note: 'contract, payment, sensitive_data ë“±']
  request_message text [not null, note: 'ìŠ¹ì¸ ìš”ì²­ ë©”ì‹œì§€']
  request_context jsonb [note: 'ìš”ì²­ ì»¨í…ìŠ¤íŠ¸ (JSON)']
  status varchar(50) [not null, default: 'pending', note: 'pending, approved, rejected']
  response_message text [note: 'ì‚¬ìš©ì ì‘ë‹µ ë©”ì‹œì§€']
  requested_at timestamp [default: `now()`, note: 'ìš”ì²­ ì‹œê°„']
  responded_at timestamp [note: 'ì‘ë‹µ ì‹œê°„']

  indexes {
    thread_id [name: 'idx_approvals_thread_id']
    status [name: 'idx_approvals_status']
    approval_type [name: 'idx_approvals_type']
    requested_at [name: 'idx_approvals_requested_at']
  }

  Note: '''
    HITL ìŠ¹ì¸ ìš”ì²­ ì´ë ¥
    - ìŠ¹ì¸/ê±°ë¶€ ì¶”ì 
    - ì»´í”Œë¼ì´ì–¸ìŠ¤ ê°ì‚¬ ë¡œê·¸
  '''
}

// ============================================
// User Management (Future Enhancement)
// ============================================

Table users {
  user_id varchar(255) [pk, note: 'ì‚¬ìš©ì ê³ ìœ  ID']
  username varchar(100) [unique, note: 'ì‚¬ìš©ìëª…']
  email varchar(255) [unique, note: 'ì´ë©”ì¼']
  full_name varchar(255) [note: 'ì „ì²´ ì´ë¦„']
  api_key_hash varchar(255) [note: 'API í‚¤ í•´ì‹œ (ì¸ì¦ìš©)']
  role varchar(50) [default: 'user', note: 'user, admin, developer']
  is_active boolean [default: true, note: 'í™œì„± ìƒíƒœ']
  created_at timestamp [default: `now()`, note: 'ìƒì„± ì‹œê°„']
  last_login_at timestamp [note: 'ë§ˆì§€ë§‰ ë¡œê·¸ì¸']

  indexes {
    username [name: 'idx_users_username']
    email [name: 'idx_users_email']
    api_key_hash [name: 'idx_users_api_key']
  }

  Note: '''
    ì‚¬ìš©ì ê´€ë¦¬ (í–¥í›„ ê¸°ëŠ¥)
    - API í‚¤ ê¸°ë°˜ ì¸ì¦
    - ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´
  '''
}

// ============================================
// Relationships
// ============================================

Ref: checkpoints.thread_id - sessions.thread_id [note: 'ì²´í¬í¬ì¸íŠ¸ëŠ” ì„¸ì…˜ì— ì†í•¨']
Ref: checkpoint_writes.thread_id > checkpoints.thread_id [note: 'ì“°ê¸°ëŠ” ì²´í¬í¬ì¸íŠ¸ì— ì†í•¨']
Ref: checkpoint_writes.checkpoint_id > checkpoints.checkpoint_id [note: 'ì“°ê¸°ëŠ” íŠ¹ì • ì²´í¬í¬ì¸íŠ¸ì™€ ì—°ê²°']

Ref: sessions.user_id > users.user_id [note: 'ì„¸ì…˜ì€ ì‚¬ìš©ìì— ì†í•¨']

// ============================================
// Enums
// ============================================

Enum session_status {
  active [note: 'í™œì„± ì„¸ì…˜']
  waiting_human [note: 'HITL ëŒ€ê¸° ì¤‘']
  in_progress [note: 'ì‹¤í–‰ ì¤‘']
  completed [note: 'ì™„ë£Œë¨']
  failed [note: 'ì‹¤íŒ¨']
  expired [note: 'ë§Œë£Œë¨']
}

Enum message_type {
  HumanMessage [note: 'ì‚¬ìš©ì ë©”ì‹œì§€']
  AIMessage [note: 'AI ì‘ë‹µ']
  SystemMessage [note: 'ì‹œìŠ¤í…œ ë©”ì‹œì§€']
  ToolMessage [note: 'ë„êµ¬ ì‹¤í–‰ ê²°ê³¼']
}

Enum agent_execution_status {
  started [note: 'ì‹œì‘ë¨']
  completed [note: 'ì™„ë£Œë¨']
  failed [note: 'ì‹¤íŒ¨']
  interrupted [note: 'HITLì— ì˜í•´ ì¤‘ë‹¨']
}

Enum hitl_approval_status {
  pending [note: 'ìŠ¹ì¸ ëŒ€ê¸°']
  approved [note: 'ìŠ¹ì¸ë¨']
  rejected [note: 'ê±°ë¶€ë¨']
  expired [note: 'ë§Œë£Œë¨ (íƒ€ì„ì•„ì›ƒ)']
}

Enum user_role {
  user [note: 'ì¼ë°˜ ì‚¬ìš©ì']
  admin [note: 'ê´€ë¦¬ì']
  developer [note: 'ê°œë°œì']
}

// ============================================
// Table Groups (Visual Organization)
// ============================================

TableGroup "LangGraph Core" {
  checkpoints
  checkpoint_writes
}

TableGroup "Session Management" {
  sessions
  session_messages
}

TableGroup "Monitoring & Logs" {
  agent_executions
  hitl_approvals
}

TableGroup "User Management" {
  users
}

// ============================================
// Notes
// ============================================

Note implementation_status {
  '''
  ## êµ¬í˜„ ìƒíƒœ

  ### âœ… êµ¬í˜„ ì™„ë£Œ
  - checkpoints: LangGraph AsyncPostgresSaver
  - checkpoint_writes: LangGraph AsyncPostgresSaver

  ### ğŸ”„ ë¶€ë¶„ êµ¬í˜„
  - sessions: í˜„ì¬ ë©”ëª¨ë¦¬ ê¸°ë°˜ (SessionManager)

  ### ğŸ“‹ í–¥í›„ êµ¬í˜„ ì˜ˆì •
  - session_messages: ë¹ ë¥¸ íˆìŠ¤í† ë¦¬ ì¡°íšŒ
  - agent_executions: ëª¨ë‹ˆí„°ë§ ë° ë¶„ì„
  - hitl_approvals: ì»´í”Œë¼ì´ì–¸ìŠ¤ ë¡œê·¸
  - users: ì¸ì¦ ë° ê¶Œí•œ ê´€ë¦¬

  ## ë°ì´í„° íë¦„

  1. ì‚¬ìš©ì ìš”ì²­ â†’ sessions ìƒì„±
  2. Graph ì‹¤í–‰ â†’ checkpoints ì €ì¥
  3. ê° ë…¸ë“œ ì‹¤í–‰ â†’ checkpoint_writes ê¸°ë¡
  4. HITL ë°œìƒ â†’ hitl_approvals ìƒì„± (ì˜µì…˜)
  5. ì—ì´ì „íŠ¸ ì‹¤í–‰ â†’ agent_executions ë¡œê¹… (ì˜µì…˜)

  ## ì„±ëŠ¥ ìµœì í™”

  - thread_idì— ì¸ë±ìŠ¤: ë¹ ë¥¸ ì„¸ì…˜ ì¡°íšŒ
  - checkpoint_idì— ì¸ë±ìŠ¤: ë¹ ë¥¸ ë³µì›
  - created_atì— ì¸ë±ìŠ¤: ì‹œê°„ ê¸°ë°˜ ì¿¼ë¦¬
  - íŒŒí‹°ì…”ë‹: ì‹œê°„ ê¸°ë°˜ íŒŒí‹°ì…”ë‹ ê°€ëŠ¥ (ëŒ€ìš©ëŸ‰ ì²˜ë¦¬)
  '''
}
