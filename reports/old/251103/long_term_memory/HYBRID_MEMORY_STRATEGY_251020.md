# Hybrid Memory ì „ëµ - ìµœê·¼ ëŒ€í™” ì „ì²´ + ê³¼ê±° ëŒ€í™” ìš”ì•½

**ì‘ì„±ì¼**: 2025-10-20
**ì œì•ˆ**: "ìµœê·¼ 5~10ê°œëŠ” ì „ì²´, 11~20ê°œëŠ” ìš”ì•½"
**í‰ê°€**: âœ… **ë§¤ìš° ì¢‹ì€ ì•„ì´ë””ì–´!**

---

## ğŸ¯ ì œì•ˆ ë‚´ìš© ë¶„ì„

### ì œì•ˆ: ê³„ì¸µì  ë©”ëª¨ë¦¬ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Recent Memory (ìµœê·¼ 5~10ê°œ)                     â”‚
â”‚  - ì „ì²´ ëŒ€í™” ë‚´ìš© (ìš”ì•½ ì—†ìŒ)                     â”‚
â”‚  - ë†’ì€ ìƒì„¸ë„                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mid-term Memory (11~20ê°œ)                      â”‚
â”‚  - ìš”ì•½ë³¸                                        â”‚
â”‚  - ì¤‘ê°„ ìƒì„¸ë„                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Long-term Memory (21ê°œ ì´ìƒ)                   â”‚
â”‚  - ì‚­ì œ ë˜ëŠ” ì••ì¶• ìš”ì•½                           â”‚
â”‚  - ë‚®ì€ ìƒì„¸ë„                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“› ìš©ì–´ ì •ì˜

### "ì´ì „ ëŒ€í™”ë¥¼ ì „ë¶€ ê°€ì ¸ì˜¤ê¸°"ë¥¼ ë­ë¼ê³  ë¶€ë¥¼ê¹Œ?

**ì—…ê³„ í‘œì¤€ ìš©ì–´**:

1. **Chat History** (ì±„íŒ… íˆìŠ¤í† ë¦¬)
   - ê°€ì¥ ì¼ë°˜ì 
   - ì›ë³¸ ë©”ì‹œì§€ ì „ì²´

2. **Conversation Buffer** (ëŒ€í™” ë²„í¼)
   - LangChain ìš©ì–´
   - ìµœê·¼ Nê°œ ë©”ì‹œì§€ ë²„í¼ë§

3. **Recent Context** (ìµœê·¼ ë§¥ë½)
   - ì„¤ëª…ì 
   - ìµœê·¼ ëŒ€í™” ë§¥ë½

4. **Short-term Memory** (ë‹¨ê¸° ë©”ëª¨ë¦¬)
   - ì‹¬ë¦¬í•™/AI ìš©ì–´
   - ìµœê·¼ ì •ë³´ ì €ì¥

**ê¶Œì¥**: âœ… **"Recent Memory" ë˜ëŠ” "Short-term Memory"**

---

### ê³„ì¸µë³„ ëª…ì¹­

```
1~10ê°œ:   Recent Memory / Short-term Memory (ë‹¨ê¸° ë©”ëª¨ë¦¬)
          â†’ ì›ë³¸ ì „ì²´

11~20ê°œ:  Mid-term Memory (ì¤‘ê¸° ë©”ëª¨ë¦¬)
          â†’ ìš”ì•½ë³¸

21ê°œ ì´ìƒ: Long-term Memory (ì¥ê¸° ë©”ëª¨ë¦¬)
          â†’ ì••ì¶• ìš”ì•½ ë˜ëŠ” ì‚­ì œ
```

---

## âœ… êµ¬í˜„ ê°€ëŠ¥ì„± ê²€í† 

### ì§ˆë¬¸ 1: "ì§€ê¸ˆ êµ¬ì¡°ì—ì„œ ì´ë ‡ê²Œ ì„¤ì •í•´ë„ ë˜ëŠ”ê°€?"

**ë‹µë³€**: âœ… **ì™„ì „íˆ ê°€ëŠ¥í•©ë‹ˆë‹¤!**

**í˜„ì¬ êµ¬ì¡°**:
- Chat History: í˜„ì¬ ì„¸ì…˜ ë‚´ ìµœê·¼ 6ê°œ (ì „ì²´)
- Long-term Memory: ë‹¤ë¥¸ ì„¸ì…˜ 5ê°œ (ìš”ì•½)

**ê°œì„  í›„**:
- Short-term Memory: ìµœê·¼ 5~10ê°œ ì„¸ì…˜ (ì „ì²´)
- Mid-term Memory: 11~20ê°œ ì„¸ì…˜ (ìš”ì•½)
- Long-term Memory: 21ê°œ ì´ìƒ (ì••ì¶• ìš”ì•½)

---

### ì§ˆë¬¸ 2: "ìš”ì•½ì€ LLMì´ë‚˜ ìš”ì•½ ëª¨ë¸ ì‚¬ìš©í•˜ê¸°?"

**ë‹µë³€**: âœ… **LLM ì‚¬ìš© ê¶Œì¥**

**3ê°€ì§€ ì˜µì…˜ ë¹„êµ**:

| ì˜µì…˜ | ë°©ë²• | ì¥ì  | ë‹¨ì  |
|------|------|------|------|
| **A. ë‹¨ìˆœ ì˜ë¼ë‚´ê¸°** | `[:200]` | ë¹ ë¦„, ë¬´ë£Œ | í’ˆì§ˆ ë‚®ìŒ |
| **B. LLM ìš”ì•½** | GPT-4o-mini | í’ˆì§ˆ ì¢‹ìŒ | ë¹„ìš©, ëŠë¦¼ |
| **C. ìš”ì•½ ëª¨ë¸** | BART, T5 | ë¹ ë¦„, ì €ë ´ | í’ˆì§ˆ ì¤‘ê°„ |

**ê¶Œì¥**: âœ… **Option B (LLM ìš”ì•½)**

**ì´ìœ **:
1. ìµœê·¼ ëŒ€í™”ëŠ” ì „ì²´ ì €ì¥ â†’ ìš”ì•½ ë¹ˆë„ ë‚®ìŒ
2. 11~20ê°œë§Œ ìš”ì•½ â†’ ë¹„ìš© ë¶€ë‹´ ì ìŒ
3. GPT-4o-mini ì €ë ´ (~$0.0001/ìš”ì²­)
4. í’ˆì§ˆì´ ì¤‘ìš”í•¨ (ë§¥ë½ ì´í•´ í•„ìš”)

---

## ğŸ—ï¸ êµ¬í˜„ ì„¤ê³„

### ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Hybrid Memory System                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ì‚¬ìš©ì ì§ˆë¬¸]
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Memory Loader (ë©”ëª¨ë¦¬ ë¡œë”)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â†“                                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Short-term Memory    â”‚              â”‚ Mid-term Memory      â”‚
â”‚ (ìµœê·¼ 5~10ê°œ)         â”‚              â”‚ (11~20ê°œ)            â”‚
â”‚ - ì „ì²´ ëŒ€í™”          â”‚              â”‚ - ìš”ì•½ë³¸             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“                                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Memory Formatter (ë©”ëª¨ë¦¬ í¬ë§·í„°)                  â”‚
â”‚    - Short-term: ì›ë³¸ ê·¸ëŒ€ë¡œ                         â”‚
â”‚    - Mid-term: "ìš”ì•½: ..." í˜•ì‹                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Context Builder (ì»¨í…ìŠ¤íŠ¸ ë¹Œë”)                   â”‚
â”‚    - Chat History (í˜„ì¬ ì„¸ì…˜)                        â”‚
â”‚    - Short-term Memory (1~10)                       â”‚
â”‚    - Mid-term Memory (11~20)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Intent Analysis / Response Generation            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» êµ¬í˜„ ì½”ë“œ

### Step 1: Hybrid Memory ë¡œë”

**íŒŒì¼**: `simple_memory_service.py` (ìƒˆ ë©”ì„œë“œ ì¶”ê°€)

```python
async def load_hybrid_memories(
    self,
    user_id: str,
    session_id: Optional[str] = None,
    recent_limit: int = 10,      # Short-term: ìµœê·¼ 10ê°œ
    midterm_limit: int = 20      # Mid-term: 11~20ê°œ
) -> Dict[str, List[Dict[str, Any]]]:
    """
    Hybrid Memory ë¡œë“œ

    Returns:
        {
            "recent": [ì„¸ì…˜1, ì„¸ì…˜2, ..., ì„¸ì…˜10],  # ì „ì²´ ëŒ€í™”
            "midterm": [ì„¸ì…˜11, ..., ì„¸ì…˜20]        # ìš”ì•½
        }
    """

    # ëª¨ë“  ì„¸ì…˜ ì¡°íšŒ (ìµœì‹ ìˆœ)
    query = select(ChatSession).where(
        ChatSession.user_id == user_id,
        ChatSession.session_metadata.isnot(None)
    )

    # í˜„ì¬ ì„¸ì…˜ ì œì™¸
    if session_id:
        query = query.where(ChatSession.session_id != session_id)

    query = query.order_by(ChatSession.updated_at.desc()).limit(midterm_limit)

    result = await self.db.execute(query)
    sessions = result.scalars().all()

    # ë¶„ë¦¬: Recent vs Mid-term
    recent_sessions = sessions[:recent_limit]
    midterm_sessions = sessions[recent_limit:midterm_limit]

    # Recent: ì „ì²´ ëŒ€í™” ë¡œë“œ
    recent_memories = []
    for session in recent_sessions:
        # ì „ì²´ ë©”ì‹œì§€ ì¡°íšŒ
        msg_query = select(ChatMessage).where(
            ChatMessage.session_id == session.session_id
        ).order_by(ChatMessage.created_at)

        msg_result = await self.db.execute(msg_query)
        messages = msg_result.scalars().all()

        recent_memories.append({
            "session_id": session.session_id,
            "title": session.title,
            "messages": [
                {
                    "role": msg.role,
                    "content": msg.content,
                    "created_at": msg.created_at.isoformat()
                }
                for msg in messages
            ],
            "timestamp": session.updated_at.isoformat()
        })

    # Mid-term: ìš”ì•½ë§Œ
    midterm_memories = []
    for session in midterm_sessions:
        metadata = session.session_metadata
        if metadata and "conversation_summary" in metadata:
            midterm_memories.append({
                "session_id": session.session_id,
                "title": session.title,
                "summary": metadata["conversation_summary"],
                "timestamp": session.updated_at.isoformat()
            })

    return {
        "recent": recent_memories,
        "midterm": midterm_memories
    }
```

---

### Step 2: ìš”ì•½ ìƒì„± (LLM ì‚¬ìš©)

**íŒŒì¼**: `simple_memory_service.py` (ìƒˆ ë©”ì„œë“œ ì¶”ê°€)

```python
async def summarize_conversation(
    self,
    messages: List[Dict[str, Any]],
    max_length: int = 200
) -> str:
    """
    LLMì„ ì‚¬ìš©í•œ ëŒ€í™” ìš”ì•½

    Args:
        messages: ëŒ€í™” ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸
        max_length: ìµœëŒ€ ìš”ì•½ ê¸¸ì´

    Returns:
        ìš”ì•½ ë¬¸ìì—´
    """
    from app.service_agent.llm_manager import LLMService

    # LLM Service ì´ˆê¸°í™”
    llm_service = LLMService()

    # ëŒ€í™” ë‚´ìš©ì„ ë¬¸ìì—´ë¡œ ë³€í™˜
    conversation_text = "\n".join([
        f"{msg['role']}: {msg['content']}"
        for msg in messages
    ])

    # LLM ìš”ì•½ ìš”ì²­
    prompt = f"""ë‹¤ìŒ ëŒ€í™”ë¥¼ {max_length}ì ì´ë‚´ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.

ëŒ€í™” ë‚´ìš©:
{conversation_text}

ìš”ì•½ (í•µì‹¬ë§Œ, {max_length}ì ì´ë‚´):"""

    summary = await llm_service.complete_async(
        prompt=prompt,
        model="gpt-4o-mini",
        temperature=0.3,
        max_tokens=100
    )

    return summary[:max_length]
```

**ëŒ€ì•ˆ (Prompt Template ì‚¬ìš©)**:

```python
# prompts/memory/conversation_summary.txt ìƒì„±

summary = await llm_service.complete_async(
    prompt_name="conversation_summary",
    variables={
        "conversation": conversation_text,
        "max_length": max_length
    }
)
```

---

### Step 3: ì €ì¥ ì‹œ ìš”ì•½ ìƒì„±

**íŒŒì¼**: `team_supervisor.py:878-894` (ìˆ˜ì •)

```python
# í˜„ì¬
response_summary = response.get("answer", "")[:200]

# ê°œì„  (LLM ìš”ì•½)
if user_id:
    async for db_session in get_async_db():
        memory_service = LongTermMemoryService(db_session)

        # âœ… ë©”ì‹œì§€ ì¡°íšŒ
        messages = await memory_service.load_recent_messages(
            session_id=chat_session_id,
            limit=50  # ì „ì²´ ëŒ€í™”
        )

        # âœ… LLM ìš”ì•½ ìƒì„±
        response_summary = await memory_service.summarize_conversation(
            messages=messages,
            max_length=200
        )

        # ì €ì¥
        await memory_service.save_conversation(
            user_id=user_id,
            session_id=chat_session_id,
            messages=[],
            summary=response_summary
        )
```

---

### Step 4: Intent ë¶„ì„ì— Hybrid Memory ì‚¬ìš©

**íŒŒì¼**: `team_supervisor.py:196-259` (ìˆ˜ì •)

```python
# í˜„ì¬
chat_history = await self._get_chat_history(session_id, limit=3)
context = {"chat_history": chat_history}

# ê°œì„  (Hybrid Memory)
chat_history = await self._get_chat_history(session_id, limit=3)

# âœ… Hybrid Memory ë¡œë“œ
hybrid_memories = await memory_service.load_hybrid_memories(
    user_id=user_id,
    session_id=chat_session_id,
    recent_limit=10,   # ìµœê·¼ 10ê°œ ì „ì²´
    midterm_limit=20   # 11~20ê°œ ìš”ì•½
)

context = {
    "chat_history": chat_history,              # í˜„ì¬ ì„¸ì…˜
    "recent_memory": hybrid_memories["recent"],   # 1~10ê°œ ì „ì²´
    "midterm_memory": hybrid_memories["midterm"]  # 11~20ê°œ ìš”ì•½
}

intent_result = await self.planning_agent.analyze_intent(query, context)
```

---

### Step 5: Prompt ìˆ˜ì •

**íŒŒì¼**: `prompts/cognitive/intent_analysis.txt`

```markdown
## ğŸ”¹ í˜„ì¬ ì„¸ì…˜ ëŒ€í™” (Chat History)

{chat_history}

---

## ğŸ”¹ ìµœê·¼ ëŒ€í™” ì „ì²´ (Short-term Memory, 1~10ê°œ ì„¸ì…˜)

ê³¼ê±° ëŒ€í™”ì°½ë“¤ì˜ ì „ì²´ ë‚´ìš©ì…ë‹ˆë‹¤.

{recent_memory}

---

## ğŸ”¹ ê³¼ê±° ëŒ€í™” ìš”ì•½ (Mid-term Memory, 11~20ê°œ ì„¸ì…˜)

ì˜¤ë˜ëœ ëŒ€í™”ì°½ë“¤ì˜ ìš”ì•½ì…ë‹ˆë‹¤.

{midterm_memory}

---

**í˜„ì¬ ì§ˆë¬¸**: {query}

**ë¶„ì„ ì§€ì¹¨**:
1. Chat Historyì—ì„œ ì§ì ‘ ì°¸ì¡° í™•ì¸ (ìµœìš°ì„ )
2. Recent Memoryì—ì„œ ê´€ë ¨ ëŒ€í™” í™•ì¸ (ë†’ì€ ìš°ì„ ìˆœìœ„)
3. Mid-term Memoryì—ì„œ ì£¼ì œ í™•ì¸ (ë³´ì¡°)
4. ì…‹ ì¤‘ í•˜ë‚˜ë¼ë„ ê´€ë ¨ ìˆìœ¼ë©´ RELEVANTë¡œ ë¶„ë¥˜
```

---

## ğŸ“Š ì„±ëŠ¥ ë¶„ì„

### í† í° ì‚¬ìš©ëŸ‰ ë¹„êµ

#### í˜„ì¬ êµ¬í˜„
```
Chat History: 6ê°œ ë©”ì‹œì§€ Ã— í‰ê·  100ì = 600ì (~300 í† í°)
Long-term Memory: 5ê°œ ìš”ì•½ Ã— 200ì = 1000ì (~500 í† í°)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
í•©ê³„: ~800 í† í°
```

#### Hybrid Memory (ì œì•ˆ)
```
Chat History: 6ê°œ ë©”ì‹œì§€ Ã— 100ì = 600ì (~300 í† í°)
Recent Memory: 10ê°œ ì„¸ì…˜ Ã— 10ê°œ ë©”ì‹œì§€ Ã— 100ì = 10,000ì (~5,000 í† í°)
Mid-term Memory: 10ê°œ ìš”ì•½ Ã— 200ì = 2,000ì (~1,000 í† í°)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
í•©ê³„: ~6,300 í† í°
```

**ì¦ê°€ëŸ‰**: +5,500 í† í° (~8ë°°)

**ë¹„ìš© ì˜í–¥** (GPT-4o-mini):
- í˜„ì¬: $0.00012/ìš”ì²­ (800 í† í°)
- ê°œì„ : $0.00095/ìš”ì²­ (6,300 í† í°)
- **ì¦ê°€: +$0.00083/ìš”ì²­**

---

### ì‘ë‹µ ì‹œê°„ ì˜í–¥

#### ì¶”ê°€ ì‹œê°„
```
1. Hybrid Memory ë¡œë“œ:
   - Recent (10ê°œ ì„¸ì…˜, ì „ì²´ ë©”ì‹œì§€): ~200ms
   - Mid-term (10ê°œ ì„¸ì…˜, ìš”ì•½ë§Œ): ~50ms

2. LLM ìš”ì•½ ìƒì„± (ì €ì¥ ì‹œ):
   - GPT-4o-mini: ~1,000ms

3. LLM Intent ë¶„ì„ (í† í° ì¦ê°€):
   - 800 í† í° â†’ 6,300 í† í°: ~300ms ì¶”ê°€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì´ ì¦ê°€: ~550ms (Intent ë¶„ì„ ì‹œ)
         ~1,250ms (ì €ì¥ ì‹œ)
```

**í—ˆìš© ê°€ëŠ¥?**
- Intent ë¶„ì„: 2s â†’ 2.55s (+27%) âš ï¸
- ì €ì¥: 0.1s â†’ 1.35s (+1250%) âš ï¸

---

## âš–ï¸ ì¥ë‹¨ì  ë¶„ì„

### âœ… ì¥ì 

1. **ë†’ì€ ì •í™•ë„**
   - Recent Memory: ì „ì²´ ëŒ€í™” â†’ ì •í™•í•œ ë§¥ë½
   - Mid-term Memory: ìš”ì•½ â†’ ì£¼ì œ íŒŒì•…

2. **ê¸´ ê¸°ì–µ**
   - 20ê°œ ì„¸ì…˜ê¹Œì§€ ê¸°ì–µ
   - í˜„ì¬ 5ê°œ ëŒ€ë¹„ 4ë°°

3. **ê· í˜• ì¡íŒ ì„¤ê³„**
   - ìµœê·¼ì€ ìƒì„¸íˆ, ê³¼ê±°ëŠ” ìš”ì•½
   - í† í°/ë¹„ìš© ìµœì í™”

4. **í’ˆì§ˆ ì¢‹ì€ ìš”ì•½**
   - LLM ìš”ì•½ â†’ ì˜ë¯¸ ë³´ì¡´
   - ë‹¨ìˆœ ì˜ë¼ë‚´ê¸° ëŒ€ë¹„ ìš°ìˆ˜

---

### âŒ ë‹¨ì 

1. **ì‘ë‹µ ì‹œê°„ ì¦ê°€**
   - +550ms (Intent ë¶„ì„)
   - +1,250ms (ì €ì¥ ì‹œ)

2. **ë¹„ìš© ì¦ê°€**
   - í† í°: 8ë°° ì¦ê°€
   - ìš”ì•½ LLM í˜¸ì¶œ ì¶”ê°€

3. **ë³µì¡ë„ ì¦ê°€**
   - ì½”ë“œ ë³µì¡ë„ ìƒìŠ¹
   - ë””ë²„ê¹… ì–´ë ¤ì›€

4. **DB ë¶€í•˜**
   - Recent Memory ë¡œë“œ ì‹œ ë©”ì‹œì§€ ëŒ€ëŸ‰ ì¡°íšŒ

---

## ğŸ’¡ ìµœì í™” ë°©ì•ˆ

### 1. Recent Memory ê°œìˆ˜ ì¡°ì •

**ì œì•ˆ**: 10ê°œ â†’ **5ê°œ**

```python
# ìµœì í™”
hybrid_memories = await memory_service.load_hybrid_memories(
    recent_limit=5,    # 10 â†’ 5 (í† í° ì ˆë°˜)
    midterm_limit=15   # 20 â†’ 15
)
```

**íš¨ê³¼**:
- í† í°: 6,300 â†’ 3,650 (-42%)
- ì‘ë‹µ ì‹œê°„: +550ms â†’ +300ms

---

### 2. ìš”ì•½ì„ ë°±ê·¸ë¼ìš´ë“œë¡œ

**ë¬¸ì œ**: ì €ì¥ ì‹œ LLM ìš”ì•½ â†’ +1,250ms

**í•´ê²°**: ë¹„ë™ê¸° ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…

```python
# ì €ì¥ (ë™ê¸°)
await memory_service.save_conversation(
    summary=response.get("answer", "")[:200]  # ì„ì‹œ ìš”ì•½
)

# ìš”ì•½ (ë¹„ë™ê¸° ë°±ê·¸ë¼ìš´ë“œ)
asyncio.create_task(
    memory_service.update_summary_with_llm(
        session_id=chat_session_id
    )
)
```

**íš¨ê³¼**:
- ì‚¬ìš©ì ì‘ë‹µ ì‹œê°„ ì¦ê°€ ì—†ìŒ
- ìš”ì•½ì€ ë‚˜ì¤‘ì— ë°±ê·¸ë¼ìš´ë“œë¡œ

---

### 3. Lazy Loading (í•„ìš”í•  ë•Œë§Œ)

**ì•„ì´ë””ì–´**: Recent MemoryëŠ” í•„ìš”í•  ë•Œë§Œ ë¡œë“œ

```python
# Intent ë¶„ì„ 1ì°¨ (Chat Historyë§Œ)
intent_result = await self.planning_agent.analyze_intent(query, {
    "chat_history": chat_history
})

# IRRELEVANTì´ë©´ Recent Memory ë¡œë“œ í›„ ì¬ë¶„ì„
if intent_result.intent_type == IntentType.IRRELEVANT:
    hybrid_memories = await memory_service.load_hybrid_memories(...)

    intent_result = await self.planning_agent.analyze_intent(query, {
        "chat_history": chat_history,
        "recent_memory": hybrid_memories["recent"]
    })
```

**íš¨ê³¼**:
- ëŒ€ë¶€ë¶„ ì¼€ì´ìŠ¤ëŠ” ë¹ ë¦„ (Chat Historyë§Œ)
- IRRELEVANTì¼ ë•Œë§Œ ì¶”ê°€ ë¡œë“œ

---

### 4. ìºì‹±

**ì•„ì´ë””ì–´**: Recent/Mid-term Memory ìºì‹±

```python
# Redis ìºì‹±
cache_key = f"hybrid_memory:{user_id}"
cached = await redis.get(cache_key)

if cached:
    return json.loads(cached)
else:
    memories = await load_hybrid_memories(...)
    await redis.setex(cache_key, 300, json.dumps(memories))  # 5ë¶„ ìºì‹œ
    return memories
```

**íš¨ê³¼**:
- DB ë¶€í•˜ ê°ì†Œ
- ì‘ë‹µ ì‹œê°„ -200ms

---

## ğŸ¯ ê¶Œì¥ êµ¬í˜„ ìˆœì„œ

### Phase 1: ê¸°ë³¸ êµ¬í˜„ (2-3ì¼)

1. âœ… `load_hybrid_memories()` êµ¬í˜„ (0.5ì¼)
2. âœ… LLM ìš”ì•½ ê¸°ëŠ¥ ì¶”ê°€ (0.5ì¼)
3. âœ… Intent ë¶„ì„ì— í†µí•© (0.5ì¼)
4. âœ… Prompt ìˆ˜ì • (0.5ì¼)
5. âœ… í…ŒìŠ¤íŠ¸ (1ì¼)

---

### Phase 2: ìµœì í™” (1-2ì¼)

1. âœ… Recent Memory ê°œìˆ˜ ì¡°ì • (5ê°œë¡œ)
2. âœ… ë°±ê·¸ë¼ìš´ë“œ ìš”ì•½ (asyncio)
3. âœ… ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

---

### Phase 3: ê³ ë„í™” (ì„ íƒ, 2-3ì¼)

1. âœ… Lazy Loading
2. âœ… Redis ìºì‹±
3. âœ… A/B í…ŒìŠ¤íŠ¸

---

## ğŸ“‹ ìµœì¢… ê¶Œì¥ì‚¬í•­

### âœ… êµ¬í˜„ ì¶”ì²œ

**ì´ìœ **:
1. ë§¤ìš° ì¢‹ì€ ì•„ì´ë””ì–´
2. ê· í˜• ì¡íŒ ì„¤ê³„
3. ì‹¤ìš©ì 

**ë‹¨, ìµœì í™” í•„ìš”**:
- Recent Memory: 10 â†’ **5ê°œ**
- ìš”ì•½: **ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬**
- Lazy Loading ë˜ëŠ” ìºì‹±

---

### ğŸ“Š ìµœì¢… ì„¤ì • ê¶Œì¥

```python
# ê¶Œì¥ ì„¤ì •
RECENT_MEMORY_LIMIT = 5     # ìµœê·¼ 5ê°œ ì„¸ì…˜ (ì „ì²´ ëŒ€í™”)
MIDTERM_MEMORY_LIMIT = 15   # 6~15ê°œ ì„¸ì…˜ (ìš”ì•½)
LONGTERM_MEMORY_LIMIT = 50  # 16~50ê°œ ì„¸ì…˜ (ì••ì¶• ìš”ì•½, Phase 2)

# ìš”ì•½ ë°©ì‹
SUMMARY_METHOD = "llm"      # LLM ìš”ì•½ (GPT-4o-mini)
SUMMARY_BACKGROUND = True   # ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬
```

---

## ğŸ¯ ê²°ë¡ 

### ì§ˆë¬¸ 1: "ì§€ê¸ˆ êµ¬ì¡°ì—ì„œ ì´ë ‡ê²Œ ì„¤ì •í•´ë„ ë˜ëŠ”ê°€?"

**ë‹µë³€**: âœ… **ì™„ì „íˆ ê°€ëŠ¥í•©ë‹ˆë‹¤**
- í˜„ì¬ êµ¬ì¡°ë¥¼ í™•ì¥í•˜ë©´ ë¨
- ìƒˆ í…Œì´ë¸” ë¶ˆí•„ìš”

---

### ì§ˆë¬¸ 2: "ì´ê±¸ ë­ë¼ê³  ë¶€ë¥´ë©´ ì¢‹ì§€?"

**ë‹µë³€**: âœ… **Hybrid Memory** ë˜ëŠ” **Tiered Memory**
- Recent Memory (1~5ê°œ, ì „ì²´)
- Mid-term Memory (6~15ê°œ, ìš”ì•½)
- Long-term Memory (16ê°œ ì´ìƒ, ì••ì¶•)

---

### ì§ˆë¬¸ 3: "ìš”ì•½ì€ LLMì´ë‚˜ ìš”ì•½ ëª¨ë¸ ì‚¬ìš©í•˜ê¸°?"

**ë‹µë³€**: âœ… **LLM ì‚¬ìš© ê¶Œì¥** (GPT-4o-mini)
- í’ˆì§ˆ ìš°ìˆ˜
- ë¹„ìš© ì €ë ´ (~$0.0001/ìš”ì²­)
- ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬ë¡œ ì†ë„ ì˜í–¥ ì—†ìŒ

---

**ì‘ì„± ì™„ë£Œ**: 2025-10-20
**êµ¬í˜„ ìš°ì„ ìˆœìœ„**: ì¤‘ê°„ (í”„ë¡œë•ì…˜ ë°°í¬ í›„ ê³ ë ¤)
