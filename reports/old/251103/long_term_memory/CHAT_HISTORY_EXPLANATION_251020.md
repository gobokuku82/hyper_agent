# Chat History vs Long-term Memory ì„¤ëª…ì„œ

**ì‘ì„±ì¼**: 2025-10-20
**ëª©ì **: í˜„ì¬ êµ¬í˜„ì˜ Chat Historyì™€ Long-term Memory ì°¨ì´ì  ëª…í™•í™”

---

## ğŸ¤” ì§ˆë¬¸: "ì§€ê¸ˆ ì±„íŒ… 5ê°œ ì‚¬ìš© ì¤‘ì¸ë°, ì´ê±¸ ìš”ì•½í•´ì„œ ì „ë‹¬í•˜ëŠ”ê±´ê°€? ì „ë¶€ë‹¤ ì „ë‹¬í•˜ëŠ”ê±´ê°€?"

**ë‹µë³€**: **ì „ë¶€ ë‹¤ ì „ë‹¬í•©ë‹ˆë‹¤ (ìš”ì•½ ì—†ìŒ)**

---

## ğŸ“Š í˜„ì¬ êµ¬í˜„ ìƒíƒœ

### 1. Chat History (í˜„ì¬ ì„¸ì…˜ ë‚´ ëŒ€í™”)

#### ğŸ“ ìœ„ì¹˜
- **íŒŒì¼**: `backend/app/service_agent/supervisor/team_supervisor.py`
- **ë©”ì„œë“œ**: `_get_chat_history()` (Lines 1008-1070)
- **í˜¸ì¶œ**: `planning_node()` (Lines 200-210)

#### ğŸ” ë™ì‘ ë°©ì‹

**Step 1: DBì—ì„œ ë©”ì‹œì§€ ì¡°íšŒ**
```python
# Line 1038-1043
query = (
    select(ChatMessage)
    .where(ChatMessage.session_id == session_id)
    .order_by(ChatMessage.created_at.desc())
    .limit(limit * 2)  # user + assistant ìŒ
)
```

**í˜„ì¬ ì„¤ì •**: `limit=3` â†’ **6ê°œ ë©”ì‹œì§€** (3ìŒ)
- ì˜ˆ: ì‚¬ìš©ì 1, AI 1, ì‚¬ìš©ì 2, AI 2, ì‚¬ìš©ì 3, AI 3

**Step 2: í¬ë§·íŒ… (ìš”ì•½ ì—†ìŒ)**
```python
# Line 1053-1062
chat_history = [
    {
        "role": msg.role,
        "content": msg.content[:500]  # ê¸¸ì´ë§Œ ì œí•œ (500ì)
    }
    for msg in messages
]
```

**ì¤‘ìš”**:
- âœ… **ìš”ì•½ ì—†ìŒ** - ì›ë³¸ ë©”ì‹œì§€ ê·¸ëŒ€ë¡œ ì „ë‹¬
- âœ… **ê¸¸ì´ ì œí•œë§Œ** - ê° ë©”ì‹œì§€ëŠ” ìµœëŒ€ 500ìë¡œ ì˜ë¦¼
- âœ… **ìµœê·¼ Nê°œë§Œ** - 6ê°œ ë©”ì‹œì§€ë§Œ (ì˜¤ë˜ëœ ëŒ€í™”ëŠ” ì œì™¸)

**Step 3: LLMì— ì „ë‹¬**
```python
# Line 189-202 (planning_agent.py)
chat_history_text = ""
if chat_history:
    formatted_history = []
    for msg in chat_history:
        role = msg.get("role", "unknown")
        content = msg.get("content", "")
        if role == "user":
            formatted_history.append(f"ì‚¬ìš©ì: {content}")
        elif role == "assistant":
            formatted_history.append(f"AI: {content}")

    if formatted_history:
        chat_history_text = "\n".join(formatted_history)
```

**LLMì— ì „ë‹¬ë˜ëŠ” í˜•ì‹** (ì˜ˆì‹œ):
```
ì‚¬ìš©ì: ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ ì•Œë ¤ì¤˜
AI: ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ëŠ” 5ì–µ~7ì–µ ë²”ìœ„ì…ë‹ˆë‹¤...
ì‚¬ìš©ì: ì†¡íŒŒêµ¬ëŠ”?
AI: ì†¡íŒŒêµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ëŠ” 4ì–µ~6ì–µ ë²”ìœ„ì…ë‹ˆë‹¤...
ì‚¬ìš©ì: 2ê°œ ë¹„êµí•´ì¤˜
AI: ê°•ë‚¨êµ¬ì™€ ì†¡íŒŒêµ¬ì˜ ì „ì„¸ ì‹œì„¸ë¥¼ ë¹„êµí•˜ë©´...
```

---

### 2. Long-term Memory (ì„¸ì…˜ ê°„ ëŒ€í™” ìš”ì•½)

#### ğŸ“ ìœ„ì¹˜
- **íŒŒì¼**: `backend/app/service_agent/foundation/simple_memory_service.py`
- **ë©”ì„œë“œ**: `save_conversation()` (Lines 277-332)
- **í˜¸ì¶œ**: `team_supervisor.py` `generate_response_node()` (Lines 889-893)

#### ğŸ” ë™ì‘ ë°©ì‹

**Step 1: ì‘ë‹µ ìš”ì•½ ìƒì„± (200ì ì œí•œ)**
```python
# Line 879-883 (team_supervisor.py)
response_summary = response.get("summary", "")
if not response_summary and response.get("answer"):
    response_summary = response.get("answer", "")[:200]  # âœ… ìš”ì•½ (200ì)
if not response_summary:
    response_summary = f"{response.get('type', 'response')} ìƒì„± ì™„ë£Œ"
```

**ì¤‘ìš”**:
- âœ… **ìš”ì•½í•¨** - 200ìë¡œ ì œí•œ
- âœ… **í•œ ëŒ€í™”ë‹¹ 1ê°œ ìš”ì•½** - ì „ì²´ ëŒ€í™” íë¦„ì„ 200ìë¡œ ì••ì¶•

**Step 2: chat_sessions.metadataì— ì €ì¥**
```python
# Line 299-322 (simple_memory_service.py)
metadata = session.metadata or {}
metadata["conversation_summary"] = summary
metadata["last_updated"] = current_time.isoformat()
metadata["message_count"] = metadata.get("message_count", 0) + 1

session.metadata = metadata
flag_modified(session, "metadata")  # JSONB ë³€ê²½ ì¶”ì 
await db_session.commit()
```

**ì €ì¥ë˜ëŠ” í˜•ì‹** (ì˜ˆì‹œ):
```json
{
  "conversation_summary": "ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ ì¡°íšŒ (5ì–µ~7ì–µ ë²”ìœ„)",
  "last_updated": "2025-10-20T16:58:31+00:00",
  "message_count": 2
}
```

**Step 3: Long-term Memory ë¡œë“œ**
```python
# Line 244-248 (team_supervisor.py)
loaded_memories = await memory_service.load_recent_memories(
    user_id=user_id,
    limit=settings.MEMORY_LOAD_LIMIT,  # ê¸°ë³¸ê°’: 5
    relevance_filter="RELEVANT",
    session_id=chat_session_id  # í˜„ì¬ ì„¸ì…˜ ì œì™¸
)
```

**ë¡œë“œë˜ëŠ” ë°ì´í„°** (ìµœê·¼ 5ê°œ ì„¸ì…˜):
```python
[
    {
        "session_id": "session-xxx",
        "summary": "ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ ì¡°íšŒ (5ì–µ~7ì–µ ë²”ìœ„)",
        "created_at": "2025-10-18T14:20:00+00:00"
    },
    {
        "session_id": "session-yyy",
        "summary": "ì „ì„¸ìê¸ˆëŒ€ì¶œ í•œë„ ì¡°íšŒ ë° ê¸ˆë¦¬ ë¹„êµ",
        "created_at": "2025-10-19T09:15:00+00:00"
    },
    ...
]
```

---

## ğŸ”„ Chat History vs Long-term Memory ë¹„êµ

| í•­ëª© | Chat History | Long-term Memory |
|------|--------------|------------------|
| **ë²”ìœ„** | í˜„ì¬ ì„¸ì…˜ë§Œ | ìµœê·¼ Nê°œ ì„¸ì…˜ (í¬ë¡œìŠ¤ ì„¸ì…˜) |
| **ë©”ì‹œì§€ ìˆ˜** | 6ê°œ (3ìŒ) | 5ê°œ ì„¸ì…˜ ìš”ì•½ |
| **ì €ì¥ í˜•ì‹** | ì›ë³¸ ë©”ì‹œì§€ (500ì ì œí•œ) | ìš”ì•½ (200ì ì œí•œ) |
| **ìš”ì•½ ì—¬ë¶€** | âŒ ì—†ìŒ (ì›ë³¸ ê·¸ëŒ€ë¡œ) | âœ… ìˆìŒ (ìš”ì•½) |
| **ì‚¬ìš© ì‹œì ** | Intent ë¶„ì„ (planning_node) | Response ìƒì„± (generate_response_node) |
| **ì €ì¥ ìœ„ì¹˜** | `chat_messages` í…Œì´ë¸” | `chat_sessions.metadata` JSONB |
| **ëª©ì ** | ë¬¸ë§¥ ì°¸ì¡° ì§ˆë¬¸ ì²˜ë¦¬ | ì´ì „ ì„¸ì…˜ ë‚´ìš© ì°¸ì¡° |
| **ì˜ˆì‹œ** | "ê·¸ëŸ¼ ì†¡íŒŒêµ¬ëŠ”?" | "ì§€ë‚œë²ˆì— ê°•ë‚¨êµ¬ ì‹œì„¸ ë¬¼ì–´ë´¤ì—ˆëŠ”ë°..." |

---

## ğŸ“ êµ¬ì²´ì ì¸ ì˜ˆì‹œ

### ì‹œë‚˜ë¦¬ì˜¤ 1: í˜„ì¬ ì„¸ì…˜ ë‚´ ëŒ€í™” (Chat History ì‚¬ìš©)

**ëŒ€í™” ê¸°ë¡** (chat_messages í…Œì´ë¸”):
```
ë©”ì‹œì§€ 1 (ì‚¬ìš©ì): "ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ ì•Œë ¤ì¤˜"
ë©”ì‹œì§€ 2 (AI): "ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ëŠ” 5ì–µ~7ì–µ ë²”ìœ„ì…ë‹ˆë‹¤. ì£¼ìš” ë‹¨ì§€ë¡œëŠ”..."
ë©”ì‹œì§€ 3 (ì‚¬ìš©ì): "ì†¡íŒŒêµ¬ëŠ”?"
ë©”ì‹œì§€ 4 (AI): "ì†¡íŒŒêµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ëŠ” 4ì–µ~6ì–µ ë²”ìœ„ì…ë‹ˆë‹¤..."
ë©”ì‹œì§€ 5 (ì‚¬ìš©ì): "2ê°œ ë¹„êµí•´ì¤˜"  â† í˜„ì¬ ì§ˆë¬¸
```

**Chat History ì¡°íšŒ ê²°ê³¼** (limit=3):
```python
[
    {"role": "user", "content": "ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ ì•Œë ¤ì¤˜"},
    {"role": "assistant", "content": "ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ëŠ” 5ì–µ~7ì–µ ë²”ìœ„ì…ë‹ˆë‹¤. ì£¼ìš” ë‹¨ì§€ë¡œëŠ”..."},
    {"role": "user", "content": "ì†¡íŒŒêµ¬ëŠ”?"},
    {"role": "assistant", "content": "ì†¡íŒŒêµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ëŠ” 4ì–µ~6ì–µ ë²”ìœ„ì…ë‹ˆë‹¤..."},
    {"role": "user", "content": "2ê°œ ë¹„êµí•´ì¤˜"}
]
```

**LLMì— ì „ë‹¬ë˜ëŠ” ë‚´ìš©** (ìš”ì•½ ì—†ìŒ):
```
ì‚¬ìš©ì: ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ ì•Œë ¤ì¤˜
AI: ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ëŠ” 5ì–µ~7ì–µ ë²”ìœ„ì…ë‹ˆë‹¤. ì£¼ìš” ë‹¨ì§€ë¡œëŠ”...
ì‚¬ìš©ì: ì†¡íŒŒêµ¬ëŠ”?
AI: ì†¡íŒŒêµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ëŠ” 4ì–µ~6ì–µ ë²”ìœ„ì…ë‹ˆë‹¤...
ì‚¬ìš©ì: 2ê°œ ë¹„êµí•´ì¤˜
```

**Intent ë¶„ì„ ê²°ê³¼**:
- Intent: MARKET_INQUIRY (0.85)
- Keywords: ['ë¹„êµ', 'ì†¡íŒŒêµ¬', 'ê°•ë‚¨êµ¬', 'ì•„íŒŒíŠ¸', 'ì „ì„¸']
- Reasoning: "ì´ì „ ëŒ€í™”ì—ì„œ ê°•ë‚¨êµ¬ì™€ ì†¡íŒŒêµ¬ ì‹œì„¸ë¥¼ ì–¸ê¸‰í–ˆìœ¼ë¯€ë¡œ, ë‘ ì§€ì—­ ë¹„êµ ìš”ì²­"

---

### ì‹œë‚˜ë¦¬ì˜¤ 2: ìƒˆ ì„¸ì…˜ì—ì„œ ì´ì „ ì„¸ì…˜ ì°¸ì¡° (Long-term Memory ì‚¬ìš©)

**ì´ì „ ì„¸ì…˜ (2ì¼ ì „)** - Session A:
```
ëŒ€í™” 1: "ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ ì•Œë ¤ì¤˜"
ëŒ€í™” 2: "5ì–µ~7ì–µ ë²”ìœ„ì…ë‹ˆë‹¤..."
```
â†’ **ì €ì¥ëœ ìš”ì•½**: "ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ ì¡°íšŒ (5ì–µ~7ì–µ ë²”ìœ„)"

**í˜„ì¬ ì„¸ì…˜ (ìƒˆ ëŒ€í™”ì°½)** - Session B:
```
ëŒ€í™” 1: "ê·¸ëŸ¼ ì†¡íŒŒêµ¬ëŠ”?"  â† í˜„ì¬ ì§ˆë¬¸
```

**Chat History ì¡°íšŒ ê²°ê³¼**:
```python
[]  # ë¹ˆ ë¦¬ìŠ¤íŠ¸ (ìƒˆ ì„¸ì…˜ì´ë¯€ë¡œ ì´ì „ ë©”ì‹œì§€ ì—†ìŒ)
```

**Long-term Memory ì¡°íšŒ ê²°ê³¼**:
```python
[
    {
        "session_id": "session-A",
        "summary": "ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ ì¡°íšŒ (5ì–µ~7ì–µ ë²”ìœ„)",
        "created_at": "2025-10-18T14:20:00+00:00"
    }
]
```

**Intent ë¶„ì„ ì‹œ**:
- Chat History ì—†ìŒ â†’ "ê·¸ëŸ¼ ì†¡íŒŒêµ¬ëŠ”?"ì˜ ë§¥ë½ íŒŒì•… ë¶ˆê°€
- ê²°ê³¼: **IRRELEVANT** (ì˜¤ë¶„ë¥˜) âŒ

**Response ìƒì„± ì‹œ**:
- Long-term Memory ìˆìŒ â†’ "ì´ì „ì— ê°•ë‚¨êµ¬ ì‹œì„¸ë¥¼ ì¡°íšŒí•˜ì…¨ë„¤ìš”" ì°¸ì¡° ê°€ëŠ¥
- í•˜ì§€ë§Œ Intentê°€ ì´ë¯¸ IRRELEVANTë¡œ ë¶„ë¥˜ë˜ì–´ ì‘ë‹µ ìƒì„± ì•ˆ í•¨ âŒ

**ë¬¸ì œì **:
- Intent ë¶„ì„ì—ëŠ” Chat Historyë§Œ ì‚¬ìš©
- Long-term MemoryëŠ” Response ìƒì„±ì—ë§Œ ì‚¬ìš©
- ìƒˆ ì„¸ì…˜ì—ì„œ ì´ì „ ì£¼ì œ ì°¸ì¡° ë¶ˆê°€

---

## ğŸ¯ í˜„ì¬ êµ¬í˜„ì˜ í•œê³„

### í•œê³„ 1: Chat History ë²”ìœ„ ì œí•œ (limit=3)

**ë¬¸ì œ**:
```
ëŒ€í™” 1: "ê°•ë‚¨êµ¬ ì‹œì„¸" (10ë¶„ ì „)
ëŒ€í™” 2-7: ë‹¤ë¥¸ ì£¼ì œë“¤ (9ë¶„ ì „ ~ 1ë¶„ ì „)
ëŒ€í™” 8: "ì•„ê¹Œ ê°•ë‚¨êµ¬ ì–¼ë§ˆë¼ê³  í–ˆì§€?" (í˜„ì¬)

Chat History: ëŒ€í™” 5, 6, 7ë§Œ ë¡œë“œ (ëŒ€í™” 1ì€ ë²”ìœ„ ë°–)
ê²°ê³¼: "ê°•ë‚¨êµ¬"ë¥¼ ì°¸ì¡°í•  ìˆ˜ ì—†ìŒ â†’ IRRELEVANT ê°€ëŠ¥ì„±
```

**í•´ê²° ë°©ì•ˆ**:
- limit=3 â†’ limit=5ë¡œ ì¦ê°€ (10ê°œ ë©”ì‹œì§€)
- ë˜ëŠ” ì‹œê°„ ê¸°ë°˜ í•„í„°ë§ (ìµœê·¼ 10ë¶„ ë‚´ ë©”ì‹œì§€)

---

### í•œê³„ 2: Long-term MemoryëŠ” Intent ë¶„ì„ì— ë¯¸ì‚¬ìš©

**ë¬¸ì œ**:
```
[ì´ì „ ì„¸ì…˜]
ì‚¬ìš©ì: "ê°•ë‚¨êµ¬ ì‹œì„¸ ì•Œë ¤ì¤˜"

[ìƒˆ ì„¸ì…˜]
ì‚¬ìš©ì: "ê·¸ëŸ¼ ì†¡íŒŒêµ¬ëŠ”?"

Chat History: ì—†ìŒ (ìƒˆ ì„¸ì…˜)
Long-term Memory: ìˆìŒ (ê°•ë‚¨êµ¬ ì‹œì„¸ ì¡°íšŒ ìš”ì•½)
Intent ë¶„ì„: IRRELEVANT âŒ (Chat Historyë§Œ ì°¸ì¡°)
```

**í•´ê²° ë°©ì•ˆ**:
- Intent ë¶„ì„ì—ë„ Long-term Memory ì „ë‹¬
- Contextì— `long_term_memory` ì¶”ê°€
- Promptì— Long-term Memory ì„¹ì…˜ ì¶”ê°€

---

### í•œê³„ 3: ìš”ì•½ ì†ì‹¤ (Long-term Memory)

**ë¬¸ì œ**:
```
ì›ë³¸ ëŒ€í™” (1000ì):
"ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ëŠ” 5ì–µ~7ì–µ ë²”ìœ„ì…ë‹ˆë‹¤.
ì£¼ìš” ë‹¨ì§€ë¡œëŠ” ëŒ€ì¹˜ë™ ì€ë§ˆì•„íŒŒíŠ¸(6ì–µ), ê°œí¬ë™ ê°œí¬ì£¼ê³µ(5.5ì–µ)...
ìµœê·¼ 1ë…„ê°„ ì•½ 10% ìƒìŠ¹í–ˆìœ¼ë©°..."

ì €ì¥ëœ ìš”ì•½ (200ì):
"ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ ì¡°íšŒ (5ì–µ~7ì–µ ë²”ìœ„)"

ì†ì‹¤ëœ ì •ë³´:
- êµ¬ì²´ì ì¸ ë‹¨ì§€ëª…
- ìƒìŠ¹ë¥ 
- ì§€ì—­ë³„ ì„¸ë¶€ ì •ë³´
```

**í•´ê²° ë°©ì•ˆ** (Phase 2):
- `conversation_memories` í…Œì´ë¸” ìƒì„±
- ì›ë³¸ query, response ì €ì¥
- Vector Embeddingìœ¼ë¡œ ì˜ë¯¸ ê²€ìƒ‰

---

## ğŸ”§ ìš”ì•½ ê¸°ëŠ¥ì€ ì–´ë–»ê²Œ í™œìš©ë˜ëŠ”ê°€?

### í˜„ì¬ í™œìš©: Long-term Memoryì—ë§Œ ì ìš©

**1. ì €ì¥ ì‹œì **:
```python
# team_supervisor.py:879-883
response_summary = response.get("answer", "")[:200]  # ìš”ì•½ (200ì)

await memory_service.save_conversation(
    user_id=user_id,
    session_id=chat_session_id,
    messages=[],
    summary=response_summary  # â† ìš”ì•½ ì €ì¥
)
```

**2. ë¡œë“œ ì‹œì **:
```python
# team_supervisor.py:244-248
loaded_memories = await memory_service.load_recent_memories(
    user_id=user_id,
    limit=5
)
# â†’ [{"summary": "ê°•ë‚¨êµ¬ ì‹œì„¸ ì¡°íšŒ (5ì–µ~7ì–µ)"}, ...]
```

**3. ì‚¬ìš© ì‹œì **:
```python
# Response ìƒì„± ì‹œ LLMì— ì „ë‹¬ (í˜„ì¬ëŠ” ì‚¬ìš© ì•ˆ í•¨)
# Phase 2ì—ì„œ êµ¬í˜„ ì˜ˆì •:
#   - Intent ë¶„ì„ì—ë„ ì „ë‹¬
#   - Response ìƒì„±ì— ëª…ì‹œì ìœ¼ë¡œ í¬í•¨
```

---

### ë¯¸ë˜ í™œìš© (Phase 2):

#### 1. Intent ë¶„ì„ì— Long-term Memory ì¶”ê°€
```python
# planning_node (team_supervisor.py)
chat_history = await self._get_chat_history(session_id, limit=3)
long_term_memory = await self._get_long_term_memory(user_id, limit=5)

context = {
    "chat_history": chat_history,      # ì›ë³¸ ë©”ì‹œì§€ (6ê°œ)
    "long_term_memory": long_term_memory  # ìš”ì•½ (5ê°œ ì„¸ì…˜)
}

intent_result = await self.planning_agent.analyze_intent(query, context)
```

#### 2. Promptì— Long-term Memory ì„¹ì…˜ ì¶”ê°€
```
## ğŸ”¹ ìµœê·¼ ëŒ€í™” ê¸°ë¡ (Chat History)
ì‚¬ìš©ì: ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ ì•Œë ¤ì¤˜
AI: 5ì–µ~7ì–µ ë²”ìœ„ì…ë‹ˆë‹¤...

## ğŸ”¹ ì´ì „ ëŒ€í™” ìš”ì•½ (Long-term Memory)
- [2ì¼ ì „] ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸ ì „ì„¸ ì‹œì„¸ ì¡°íšŒ (5ì–µ~7ì–µ ë²”ìœ„)
- [3ì¼ ì „] ì „ì„¸ìê¸ˆëŒ€ì¶œ í•œë„ ì¡°íšŒ ë° ê¸ˆë¦¬ ë¹„êµ

**í˜„ì¬ ì§ˆë¬¸**: ê·¸ëŸ¼ ì†¡íŒŒêµ¬ëŠ”?

**ë¶„ì„ ì§€ì¹¨**:
1. Chat Historyì—ì„œ ì§ì ‘ ì°¸ì¡° í™•ì¸
2. Long-term Memoryì—ì„œ ê´€ë ¨ ì£¼ì œ í™•ì¸
3. ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ê´€ë ¨ ìˆìœ¼ë©´ RELEVANTë¡œ ë¶„ë¥˜
```

#### 3. ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰ (Vector DB)
```python
# Phase 2: conversation_memories í…Œì´ë¸” ì‚¬ìš©
similar_memories = await memory_service.search_similar_conversations(
    user_id=user_id,
    query="ì†¡íŒŒêµ¬ ì‹œì„¸",
    limit=3
)
# â†’ Vector ìœ ì‚¬ë„ ê²€ìƒ‰ìœ¼ë¡œ ê´€ë ¨ ëŒ€í™” ì°¾ê¸°
```

---

## ğŸ“Š ë°ì´í„° íë¦„ ì •ë¦¬

### í˜„ì¬ êµ¬í˜„ (Option A)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 í˜„ì¬ ì§ˆë¬¸ ì²˜ë¦¬ íë¦„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ì‚¬ìš©ì ì§ˆë¬¸: "ê·¸ëŸ¼ ì†¡íŒŒêµ¬ëŠ”?"
   â†“
2. planning_node (team_supervisor.py:200-210)
   â†“
3. _get_chat_history() í˜¸ì¶œ
   â”œâ”€ DB ì¡°íšŒ: chat_messages í…Œì´ë¸”
   â”œâ”€ ìµœê·¼ 6ê°œ ë©”ì‹œì§€ ë¡œë“œ (limit=3ìŒ)
   â”œâ”€ í¬ë§·íŒ…: {"role": "user", "content": "..."}
   â””â”€ ë°˜í™˜: ì›ë³¸ ë©”ì‹œì§€ (ìš”ì•½ ì—†ìŒ)
   â†“
4. Context ìƒì„±
   context = {"chat_history": chat_history}
   â†“
5. analyze_intent(query, context)
   â”œâ”€ _analyze_with_llm()
   â”œâ”€ Chat Historyë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
   â”‚   "ì‚¬ìš©ì: ...\nAI: ...\nì‚¬ìš©ì: ..."
   â”œâ”€ LLMì— ì „ë‹¬ (intent_analysis.txt)
   â””â”€ Intent ë¶„ì„ ê²°ê³¼ ë°˜í™˜
   â†“
6. Long-term Memory ë¡œë“œ (ë³„ë„)
   â”œâ”€ load_recent_memories()
   â”œâ”€ ìµœê·¼ 5ê°œ ì„¸ì…˜ ìš”ì•½ ë¡œë“œ
   â””â”€ Response ìƒì„±ì—ë§Œ ì‚¬ìš© (Intent ë¶„ì„ X)
   â†“
7. Response ìƒì„±
   â”œâ”€ Long-term Memory ì°¸ì¡° ê°€ëŠ¥
   â””â”€ ìµœì¢… ì‘ë‹µ
   â†“
8. save_conversation()
   â”œâ”€ ì‘ë‹µ ìš”ì•½ ìƒì„± (200ì)
   â”œâ”€ chat_sessions.metadataì— ì €ì¥
   â””â”€ ë‹¤ìŒ ì„¸ì…˜ì—ì„œ Long-term Memoryë¡œ ì‚¬ìš©
```

---

## ğŸ’¡ í•µì‹¬ ì •ë¦¬

### Chat History (í˜„ì¬ ì„¸ì…˜)
- âœ… **ìš”ì•½ ì—†ìŒ** - ì›ë³¸ ë©”ì‹œì§€ ê·¸ëŒ€ë¡œ ì „ë‹¬
- âœ… **6ê°œ ë©”ì‹œì§€** - ìµœê·¼ 3ìŒ (limit=3)
- âœ… **500ì ì œí•œ** - ê° ë©”ì‹œì§€ ìµœëŒ€ 500ì
- âœ… **Intent ë¶„ì„ì— ì‚¬ìš©** - ë¬¸ë§¥ ì°¸ì¡° ì§ˆë¬¸ ì²˜ë¦¬

### Long-term Memory (í¬ë¡œìŠ¤ ì„¸ì…˜)
- âœ… **ìš”ì•½í•¨** - 200ìë¡œ ì••ì¶•
- âœ… **5ê°œ ì„¸ì…˜** - ìµœê·¼ 5ê°œ ì„¸ì…˜ ìš”ì•½
- âœ… **ì„¸ì…˜ë³„ 1ê°œ** - í•œ ì„¸ì…˜ë‹¹ 1ê°œ ìš”ì•½
- âš ï¸ **Response ìƒì„±ì—ë§Œ ì‚¬ìš©** - Intent ë¶„ì„ì—ëŠ” ë¯¸ì‚¬ìš© (ê°œì„  í•„ìš”)

### ì£¼ìš” ì°¨ì´ì 
| | Chat History | Long-term Memory |
|---|---|---|
| **ìš”ì•½ ì—¬ë¶€** | âŒ ì—†ìŒ (ì›ë³¸) | âœ… ìˆìŒ (200ì) |
| **ë©”ì‹œì§€ ìˆ˜** | 6ê°œ (ìµœê·¼ 3ìŒ) | 5ê°œ (ì„¸ì…˜ ìš”ì•½) |
| **ë²”ìœ„** | í˜„ì¬ ì„¸ì…˜ë§Œ | ìµœê·¼ 5ê°œ ì„¸ì…˜ |
| **ì‚¬ìš©ì²˜** | Intent ë¶„ì„ | Response ìƒì„± |

---

**ì‘ì„± ì™„ë£Œ**: 2025-10-20
**ë‹¤ìŒ ê°œì„ **: Phase 2ì—ì„œ Intent ë¶„ì„ì—ë„ Long-term Memory ì¶”ê°€
