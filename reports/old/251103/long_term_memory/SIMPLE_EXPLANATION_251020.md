# Long-term Memory 간단 설명

**질문**: "지금 채팅 5개 사용 중인데, 이걸 요약해서 전달하는건가? 전부다 전달하는건가?"

---

## 📌 핵심 답변

현재 **2가지 다른 메커니즘**이 작동하고 있습니다:

### 1️⃣ Chat History (현재 대화창 내)
- **대상**: 현재 대화창의 최근 6개 메시지 (3쌍)
- **요약**: ❌ **없음** - 메시지 전체를 그대로 전달
- **언제**: Intent 분석 시점 (질문이 들어오자마자)
- **목적**: "그럼 송파구는?" 같은 문맥 참조 질문 이해

### 2️⃣ Long-term Memory (다른 대화창들)
- **대상**: 다른 대화창 5개의 요약
- **요약**: ✅ **있음** - 각 대화창당 200자 요약
- **언제**: Response 생성 시점 (답변 만들 때)
- **목적**: "지난번에 강남구 물어봤었는데..." 같은 크로스 세션 참조

---

## 🎯 구체적 예시

### 상황: 현재 대화창에서 5개 대화 진행 중

```
[현재 대화창]
대화 1: "강남구 시세 알려줘" → "5억~7억입니다"
대화 2: "송파구는?" → "4억~6억입니다"
대화 3: "서초구는?" → "6억~8억입니다"
대화 4: "전세자금대출 한도는?" → "최대 3억입니다"
대화 5: "금리는?" → "연 3.5%입니다"
대화 6 (현재): "2개 비교해줘"  ← 지금 입력
```

### 질문: "2개 비교해줘"를 입력했을 때

#### 1️⃣ Chat History가 하는 일 (Intent 분석용)

**로드하는 메시지** (최근 3쌍 = 6개):
```
대화 2: "송파구는?" → "4억~6억입니다"
대화 3: "서초구는?" → "6억~8억입니다"
대화 4: "전세자금대출 한도는?" → "최대 3억입니다"
```

**LLM에 전달되는 내용** (요약 없이 그대로):
```
사용자: 송파구는?
AI: 송파구 아파트 전세 시세는 4억~6억 범위입니다...
사용자: 서초구는?
AI: 서초구 아파트 전세 시세는 6억~8억 범위입니다...
사용자: 전세자금대출 한도는?
AI: 전세자금대출 한도는 최대 3억입니다...
```

**Intent 분석 결과**:
- "2개 비교"가 무엇을 비교하는지 Chat History에서 파악
- "송파구"와 "서초구" 시세 비교로 판단
- Intent: MARKET_INQUIRY

#### 2️⃣ Long-term Memory가 하는 일 (Response 생성용)

**만약 이전 대화창들이 있었다면** (예: 2일 전, 3일 전):
```
[2일 전 대화창]
대화: "강남구 시세 + 대출 상담 + 계약서 검토..."
→ 저장된 요약: "강남구 아파트 전세 시세 조회 및 계약 상담 (5억~7억)"

[3일 전 대화창]
대화: "송파구 투자 분석..."
→ 저장된 요약: "송파구 아파트 투자 분석 및 리스크 평가"
```

**Response 생성 시**:
- 위 요약들을 참고하여 더 맥락있는 답변 생성 가능
- 예: "이전에도 송파구 투자 분석을 문의하셨었는데..."

---

## 🔄 현재 상태 요약

### Chat History (Option A, 방금 구현 완료)
```python
# Line 200-210 (team_supervisor.py)

# 1. 현재 대화창에서 최근 6개 메시지 로드
chat_history = await self._get_chat_history(
    session_id=chat_session_id,
    limit=3  # 3쌍 = 6개 메시지
)

# 2. 요약 없이 그대로 Context 생성
context = {"chat_history": chat_history}

# 3. Intent 분석에 전달
intent_result = await self.planning_agent.analyze_intent(query, context)
```

**전달되는 데이터 형식**:
```python
{
    "chat_history": [
        {"role": "user", "content": "송파구는?"},
        {"role": "assistant", "content": "송파구 아파트 전세 시세는 4억~6억..."},
        {"role": "user", "content": "서초구는?"},
        {"role": "assistant", "content": "서초구 아파트 전세 시세는 6억~8억..."},
        ...
    ]
}
```

---

### Long-term Memory (Phase 1, 이전에 구현 완료)
```python
# Line 244-249 (team_supervisor.py)

# 1. 다른 대화창 5개의 요약 로드
loaded_memories = await memory_service.load_recent_memories(
    user_id=user_id,
    limit=5,  # 5개 대화창
    session_id=chat_session_id  # 현재 대화창 제외
)

# 2. State에 저장
state["loaded_memories"] = loaded_memories
```

**로드되는 데이터 형식**:
```python
[
    {
        "session_id": "session-xxx",
        "summary": "강남구 아파트 전세 시세 조회 및 계약 상담 (5억~7억)",  # ← 요약됨 (200자)
        "created_at": "2025-10-18T14:20:00"
    },
    {
        "session_id": "session-yyy",
        "summary": "송파구 아파트 투자 분석 및 리스크 평가",  # ← 요약됨 (200자)
        "created_at": "2025-10-19T09:15:00"
    },
    ...
]
```

**저장 시점** (대화 종료 후):
```python
# Line 669-685 (team_supervisor.py)

# 응답 요약 생성 (200자로 압축)
response_summary = response.get("answer", "")[:200]

# chat_sessions.metadata에 저장
await memory_service.save_conversation(
    user_id=user_id,
    session_id=chat_session_id,
    messages=[],  # Phase 1에서는 빈 리스트
    summary=response_summary  # ← 200자 요약
)
```

---

## 🤔 왜 두 메커니즘이 다른가?

### Chat History (요약 안 함)
- **이유**: 최근 대화는 **정확한 문맥**이 중요
- **예**: "그럼 송파구는?"에서 "그럼"이 가리키는 대상을 정확히 찾아야 함
- **방법**: 원본 메시지 그대로 전달 (최대 500자로만 제한)

### Long-term Memory (요약함)
- **이유**: 오래된 대화는 **핵심만** 기억하면 충분
- **예**: "2일 전에 강남구 시세를 물어봤었다"는 정보만 있으면 됨
- **방법**: 200자 요약으로 압축하여 저장

---

## 📊 데이터 흐름 (간단 버전)

```
┌─────────────────────────────────────────────────────────┐
│  사용자 질문: "2개 비교해줘"                               │
└─────────────────────────────────────────────────────────┘
                       ↓
       ┌───────────────┴───────────────┐
       │                               │
       ↓                               ↓
┌─────────────────┐          ┌─────────────────┐
│ Chat History    │          │ Long-term Memory│
│ (현재 대화창)    │          │ (다른 대화창)    │
└─────────────────┘          └─────────────────┘
       │                               │
       │ 최근 6개 메시지               │ 5개 대화창 요약
       │ (요약 없음)                   │ (200자 요약)
       ↓                               ↓
┌─────────────────┐          ┌─────────────────┐
│ Intent 분석     │          │ Response 생성   │
│ (질문 이해)     │          │ (답변 작성)     │
└─────────────────┘          └─────────────────┘
       │                               │
       │ Intent: MARKET_INQUIRY        │ 맥락 참고
       └───────────────┬───────────────┘
                       ↓
              ┌─────────────────┐
              │  최종 응답       │
              │ "송파구와       │
              │  서초구를       │
              │  비교하면..."   │
              └─────────────────┘
```

---

## ✅ 정리

### 질문: "채팅 5개 사용 중인데, 요약해서 전달하는건가?"

**답변**:
1. **현재 대화창의 5개 대화** → ❌ 요약 안 함 (최근 3쌍만 원본 그대로)
2. **다른 대화창 5개** → ✅ 요약함 (각 200자)

### 질문: "요약하는 기능은 어떻게 활용되는건가?"

**답변**:
- Long-term Memory에서만 사용
- 대화 종료 시 응답 내용을 200자로 요약해서 저장
- 나중에 다른 대화창에서 참고 가능 (크로스 세션 메모리)

---

**작성 완료**: 2025-10-20
