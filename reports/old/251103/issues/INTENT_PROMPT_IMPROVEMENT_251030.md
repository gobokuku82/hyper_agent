# Intent Analysis Prompt 개선 계획서

**작성일**: 2025-10-30
**작성자**: AI Agent
**관련 파일**: `backend/app/service_agent/llm_manager/prompts/cognitive/intent_analysis.txt`

---

## 1. 문제 정의

### 1.1 현재 상황
현재 `intent_analysis.txt`는 **Few-shot Learning 방식**으로 구성되어 있습니다:
- **15개 의도 카테고리** 각각에 대해 4-5개의 하드코딩된 예시 제공
- 총 **70개 이상의 예시 질문** 포함
- 프롬프트 길이: **385줄** (약 3,000 토큰)

### 1.2 발생한 문제들

#### 문제 1: 관리비 질문 → IRRELEVANT 오분류
```
질문: "관리비의 부과 대상과 납부 의무자는 누구인가요?"
잘못된 분류: IRRELEVANT
올바른 분류: LEGAL_INQUIRY
```

**원인**:
- Line 12의 "법률/권리 관련" 키워드에 "관리비" 누락
- LEGAL_INQUIRY 예시(Lines 85-99)에 관리비 관련 질문 없음

**해결**: 키워드와 예시 4개 추가 (2025-10-30 완료)

#### 문제 2 (예상): 공인중개사 금지행위 질문
```
질문: "공인중개사가 할 수 없는 금지행위에는 어떤 것들이 있나요?"
예상 분류: LEGAL_INQUIRY (공인중개사법 관련)
현재 상태: 예시 없음 → 오분류 가능성
```

**현재 LEGAL_INQUIRY 예시**:
- ✅ 임대차보호법 (전세금 인상, 계약 갱신)
- ✅ 계약 관련 (계약금, 위약금, 확정일자)
- ✅ 청약 관련 (당첨, 재당첨 제한)
- ✅ 관리비 관련 (방금 추가)
- ❌ **공인중개사법** (중개사 금지행위, 중개보수, 중개계약)
- ❌ **부동산등기법** (등기 종류, 등기절차)
- ❌ **민법** (부동산 소유권, 매매계약)

### 1.3 근본 원인
**Few-shot Learning의 Coverage 문제**:
- 부동산 관련 법률은 **10개 이상** (임대차보호법, 공인중개사법, 부동산등기법, 민법, 주택법, 건축법 등)
- 각 법률당 5개 예시 추가 시 → **50개 이상** 예시 필요
- 프롬프트 길이 폭발 → 비용 증가, 응답 속도 저하

---

## 2. 두 가지 접근법 비교

### 접근법 A: 예시 계속 추가 (Few-shot Expansion)

#### 장점
- ✅ **즉시 적용 가능**: 예시만 추가하면 됨
- ✅ **구조 변경 없음**: 기존 프롬프트 엔지니어링 유지
- ✅ **안정성 높음**: 이미 검증된 방식
- ✅ **특정 케이스 정확도 향상**: 예시가 있는 질문은 높은 정확도

#### 단점
- ❌ **프롬프트 길이 폭발**: 500줄+ (현재 385줄)
- ❌ **토큰 비용 증가**: 3,000 → 5,000+ 토큰
- ❌ **유지보수 어려움**: 새로운 법률/정책 추가 시마다 수동 업데이트
- ❌ **확장성 제한**: 모든 경우를 커버할 수 없음
- ❌ **일관성 문제**: 예시가 없는 유사 질문은 오분류 가능

#### 추가해야 할 예시 (예상)
```python
# LEGAL_INQUIRY에 추가 필요:
* "공인중개사가 할 수 없는 금지행위는?" (공인중개사법)
* "중개보수 요율이 법으로 정해져 있나요?" (공인중개사법)
* "소유권이전등기는 언제까지 해야 하나요?" (부동산등기법)
* "가등기와 본등기의 차이는?" (부동산등기법)
* "매도인의 하자담보책임이 뭔가요?" (민법)
* "주택 층간소음 법적 기준이 있나요?" (주택법)
* "공동주택 관리규약 위반 시 제재는?" (주택법)
* "재건축 안전진단 법적 절차는?" (도시정비법)
```

**결과**: LEGAL_INQUIRY 예시가 **8개 → 18개**로 증가

---

### 접근법 B: 설명형 프롬프트로 전환 (Descriptive Prompting)

#### 개념
**Few-shot Examples → Descriptive Rules**로 전환

**Before (현재)**:
```
### 2. LEGAL_INQUIRY (법률해설)
- 예시 1: "전세금 인상 가능한가요?"
- 예시 2: "계약 갱신 거부할 수 있나요?"
- 예시 3: "확정일자 꼭 받아야 하나요?"
...
```

**After (제안)**:
```
### 2. LEGAL_INQUIRY (법률해설)
**판단 기준**:
1. 질문이 부동산 관련 법률/규정/정책의 적용/해석을 요구하는가?
2. "가능한가요?", "해야 하나요?", "법으로 정해져 있나요?" 같은 법적 판단 요청인가?
3. 권리/의무/제한/절차/요건에 대한 질문인가?

**포함되는 법률 영역**:
- 임대차 관련: 주택임대차보호법 (전세금 인상, 계약 갱신, 보증금 반환)
- 중개 관련: 공인중개사법 (중개보수, 금지행위, 중개계약)
- 등기 관련: 부동산등기법 (등기 종류, 등기절차, 효력)
- 계약 관련: 민법 (매매계약, 하자담보책임, 소유권)
- 주택 관리: 주택법, 공동주택관리법 (관리비, 관리규약, 층간소음)
- 건축 관련: 건축법 (건축 허가, 용도변경, 불법 증축)
- 정비사업: 도시정비법 (재건축, 재개발, 안전진단)
- 청약/분양: 주택공급규칙 (청약 자격, 당첨, 재당첨 제한)

**대표 질문 패턴** (2-3개만 유지):
- "X는 법으로 정해져 있나요?"
- "X를 할 수 있나요/해야 하나요?"
- "X 위반 시 어떤 법적 조치가 있나요?"

**키워드**: 법, 권리, 의무, 가능, 제한, 절차, 요건, 규정, 조항
```

#### 장점
- ✅ **확장성**: 새로운 법률 영역 자동 커버
- ✅ **프롬프트 간결화**: 385줄 → 250줄 예상 (35% 감소)
- ✅ **토큰 비용 절감**: 3,000 → 2,000 토큰
- ✅ **유지보수 용이**: 법률 영역만 추가하면 됨
- ✅ **일관성 향상**: 규칙 기반 판단으로 예측 가능
- ✅ **LLM 추론 능력 활용**: GPT-4/Claude는 설명형 프롬프트에 강함

#### 단점
- ❌ **재설계 필요**: 전체 프롬프트 재작성
- ❌ **초기 테스트 비용**: 정확도 검증 필요 (100개 이상 질문 테스트)
- ❌ **불확실성**: Few-shot보다 정확도가 떨어질 가능성
- ❌ **LLM 의존도 증가**: 모델 성능에 더 민감

#### 필요한 작업
1. 각 Intent 카테고리별 **판단 기준** 정의
2. **법률/정책 영역 목록** 작성 (LEGAL_INQUIRY, POLICY_INQUIRY)
3. **질문 패턴** 정의 (2-3개만 유지)
4. 테스트 데이터셋 작성 (100개 질문)
5. A/B 테스트로 정확도 비교

---

## 3. 하이브리드 접근법 (제안)

### 3.1 핵심 아이디어
**"설명형 규칙 + 핵심 예시"** 조합

- **주요 규칙**: 판단 기준, 법률 영역, 질문 패턴
- **핵심 예시**: 카테고리당 2-3개 (애매한 경계 케이스만)

### 3.2 구조 예시

```
### 2. LEGAL_INQUIRY (법률해설) 📚
- **Tool**: legal_search_tool.py (Search)
- **설명**: 부동산 관련 법률 적용, 해석, 권리/의무 질문

**판단 기준**:
✓ 법률/규정/정책의 적용/해석 요구
✓ "가능한가요?", "해야 하나요?" 같은 법적 판단 질문
✓ 권리/의무/제한/절차/요건에 대한 질문

**포함되는 법률 영역**:
- 임대차: 주택임대차보호법 (전세금 인상, 계약 갱신, 보증금 반환)
- 중개: 공인중개사법 (중개보수, 금지행위, 중개계약)
- 등기: 부동산등기법 (등기 종류, 절차, 효력)
- 계약: 민법 (매매계약, 하자담보책임)
- 관리: 주택법, 공동주택관리법 (관리비, 관리규약, 층간소음)
- 건축: 건축법 (건축허가, 용도변경, 불법증축)
- 정비: 도시정비법 (재건축, 재개발)
- 청약: 주택공급규칙 (청약자격, 당첨, 재당첨제한)

**대표 예시** (경계 케이스만):
* "관리비를 체납하면 어떤 법적 조치를 받나요?" (주택법 vs 민법 경계)
* "공인중개사가 양쪽 수수료 받아도 되나요?" (공인중개사법)
* "전세금 인상 한도가 법으로 정해져 있나요?" (임대차보호법)

**키워드**: 법, 권리, 의무, 가능, 제한, 절차, 요건, 규정, 조항, 위반, 제재
```

### 3.3 장점
- ✅ **Few-shot의 안정성** + **설명형의 확장성**
- ✅ **프롬프트 길이 중간** (385줄 → 300줄, 22% 감소)
- ✅ **점진적 마이그레이션 가능**: 카테고리별 순차 적용
- ✅ **리스크 최소화**: 기존 예시 일부 유지

---

## 4. 권장 방안

### 4.1 단계별 실행 계획

#### Phase 1: 긴급 패치 (즉시)
**목표**: 현재 알려진 오분류 해결
**방법**: 접근법 A (예시 추가)

**추가할 예시**:
```python
# LEGAL_INQUIRY에 추가:
* "공인중개사가 할 수 없는 금지행위에는 어떤 것들이 있나요?"
* "중개보수 요율이 법으로 정해져 있나요?"
* "부동산 중개계약서 작성 시 필수 항목은?"

# TERM_DEFINITION vs LEGAL_INQUIRY 경계 명확화:
- "X가 뭐야?" → TERM_DEFINITION
- "X는 법으로 정해져 있나요?" → LEGAL_INQUIRY
```

**작업 시간**: 1시간
**리스크**: 낮음

---

#### Phase 2: 하이브리드 전환 (1주일 내)
**목표**: LEGAL_INQUIRY, POLICY_INQUIRY 카테고리만 하이브리드 방식으로 전환
**방법**: 접근법 C (하이브리드)

**작업 내용**:
1. LEGAL_INQUIRY 프롬프트 재작성:
   - 판단 기준 정의
   - 8개 법률 영역 목록 작성
   - 예시 8개 → 3개로 축소 (경계 케이스만)

2. POLICY_INQUIRY 프롬프트 재작성:
   - 정부 정책 유형 정의 (청약, 대출, 세제)
   - 예시 4개 → 2개로 축소

3. 테스트:
   - 50개 질문으로 정확도 검증
   - 기존 방식과 비교

**작업 시간**: 8시간 (설계 4h + 구현 2h + 테스트 2h)
**리스크**: 중간 (LEGAL_INQUIRY는 핵심 기능이므로 신중)

---

#### Phase 3: 전체 전환 (2주일 내)
**목표**: 나머지 13개 카테고리도 하이브리드 방식 적용
**방법**: Phase 2 결과 기반 확장

**조건**:
- Phase 2에서 정확도가 **90% 이상** 유지될 경우에만 진행
- 정확도 하락 시 → Phase 1으로 롤백

**작업 시간**: 20시간
**리스크**: 중간

---

### 4.2 최종 권장사항

#### 즉시 실행: Phase 1 (긴급 패치)
```python
# 파일: intent_analysis.txt
# 라인 98-102 (LEGAL_INQUIRY 예시) 뒤에 추가:

  * "공인중개사가 할 수 없는 금지행위에는 어떤 것들이 있나요?"
  * "부동산 중개보수 요율이 법으로 정해져 있나요?"
  * "부동산 중개계약서 작성 시 필수 기재 사항은?"
  * "소유권이전등기는 계약 후 언제까지 해야 하나요?"
```

#### 1주일 내 실행: Phase 2 (하이브리드 전환 실험)
- LEGAL_INQUIRY 카테고리만 하이브리드로 전환
- 50개 테스트 질문으로 검증
- 정확도 90% 이상 → Phase 3 진행
- 정확도 90% 미만 → Phase 1 유지

---

## 5. 예상 효과

### 5.1 Phase 1 완료 시
- ✅ 공인중개사법 관련 질문 정확도 향상
- ✅ 즉시 적용 가능
- ⚠️ 프롬프트 길이 385줄 → 400줄 (+15줄)

### 5.2 Phase 2 완료 시 (LEGAL_INQUIRY만)
- ✅ 새로운 법률 영역 자동 커버
- ✅ LEGAL_INQUIRY 섹션 길이 50줄 → 30줄 (-40%)
- ✅ 유지보수 시간 50% 절감

### 5.3 Phase 3 완료 시 (전체)
- ✅ 전체 프롬프트 385줄 → 280줄 (-27%)
- ✅ 토큰 비용 3,000 → 2,200 (-27%)
- ✅ 새로운 질문 유형 자동 대응 능력 향상

---

## 6. 리스크 관리

### 6.1 정확도 하락 리스크
**완화 방안**:
- A/B 테스트로 정확도 모니터링
- 임계값: 90% 이상 유지 필수
- 롤백 가능하도록 기존 프롬프트 백업

### 6.2 LLM 모델 의존도 증가
**완화 방안**:
- Claude 3.5 Sonnet / GPT-4o 이상 사용 (추론 능력 높음)
- Temperature=0.0 유지 (일관성 보장)

### 6.3 경계 케이스 오분류
**완화 방안**:
- 경계 케이스는 예시로 유지 (하이브리드 접근법)
- 예: TERM_DEFINITION vs LEGAL_INQUIRY

---

## 7. 결론

### 질문: "공인중개사 금지행위" 질문도 추가해야 하나?
**답변**: **예, 추가해야 합니다 (Phase 1)**

하지만 장기적으로는 **Phase 2 (하이브리드 전환)** 진행을 권장합니다.

### 질문: 하드코딩을 설명형으로 바꾸는 게 나을까?
**답변**: **하이브리드 방식 (설명형 + 핵심 예시)이 최적**

**이유**:
1. Few-shot만으로는 모든 경우를 커버할 수 없음 (무한 증가)
2. 설명형만으로는 불확실성 증가 (경계 케이스 오분류)
3. 하이브리드 방식이 **안정성 + 확장성** 동시 확보

---

## 8. Action Items

- [ ] **즉시**: Phase 1 실행 (공인중개사법 예시 4개 추가)
- [ ] **1일 내**: Phase 2 설계 (LEGAL_INQUIRY 하이브리드 프롬프트 작성)
- [ ] **3일 내**: Phase 2 구현 및 테스트 (50개 질문)
- [ ] **1주일 내**: Phase 2 결과 검토 및 의사결정
- [ ] **2주일 내**: Phase 3 진행 여부 결정

---

**문서 버전**: 1.0
**다음 리뷰 예정**: Phase 2 테스트 완료 후
